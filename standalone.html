<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆKPIãƒ„ãƒªãƒ¼ä½œæˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8fafc;
            min-height: 100vh;
        }
        
        .header {
            background-color: white;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        }
        
        .header-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 4rem;
        }
        
        .header-left {
            display: flex;
            align-items: center;
        }
        
        .title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2563eb;
            margin: 0;
        }
        
        .subtitle {
            margin-left: 1rem;
            font-size: 0.875rem;
            color: #64748b;
        }
        
        .header-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn {
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 0.75rem;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }
        
        .btn-secondary {
            border: 1px solid #e2e8f0;
            background-color: #f8fafc;
            color: #0f172a;
        }
        
        .btn-primary {
            background-color: #2563eb;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1d4ed8;
        }
        
        .btn:disabled {
            background-color: #f1f5f9;
            cursor: not-allowed;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 4rem);
        }
        
        .canvas-container {
            flex: 1;
            position: relative;
        }
        
        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        .empty-content {
            text-align: center;
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .empty-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #0f172a;
        }
        
        .empty-text {
            color: #64748b;
            margin-bottom: 1.5rem;
            font-size: 1rem;
        }
        
        .btn-add-root {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            background-color: #2563eb;
            color: white;
            transition: all 0.2s ease-in-out;
        }
        
        .btn-add-root:hover {
            background-color: #1d4ed8;
        }
        
        .canvas {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: #f9fafb;
        }
        
        .canvas-content {
            position: absolute;
            top: 0;
            left: 0;
            min-width: 1200px;
            min-height: 800px;
        }
        
        .connections {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .node {
            position: absolute;
            width: 200px;
            min-height: 80px;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            border: 2px solid #e2e8f0;
            cursor: pointer;
            z-index: 2;
            transition: all 0.2s ease;
        }
        
        .node.selected {
            border-color: #2563eb;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }
        
        .node-content {
            padding: 0.75rem;
        }
        
        .node-name {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            color: #2563eb;
        }
        
        .node-description {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }
        
        .node-values {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
        }
        
        .node-value {
            color: #10b981;
            font-weight: 500;
        }
        
        .node-target {
            color: #f59e0b;
            font-weight: 500;
        }
        
        .node-formula {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.25rem;
            font-style: italic;
        }
        
        .add-child-btn {
            position: absolute;
            bottom: -0.75rem;
            left: 50%;
            transform: translateX(-50%);
            width: 1.5rem;
            height: 1.5rem;
            background-color: #2563eb;
            color: white;
            border-radius: 50%;
            font-size: 0.75rem;
            border: none;
            cursor: pointer;
        }

        .delete-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 1rem;
            height: 1rem;
            background-color: #dc2626;
            color: white;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
        }

        .delete-btn:hover {
            opacity: 1;
            background-color: #b91c1c;
        }
        
        .hint-panel {
            width: 320px;
            border-left: 1px solid #e2e8f0;
            background-color: white;
            overflow-y: auto;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .hint-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .hint-title {
            font-weight: 600;
            font-size: 1.125rem;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .node-info {
            padding: 1rem;
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .node-info-name {
            font-weight: 500;
            color: #2563eb;
            margin-bottom: 0.25rem;
        }
        
        .node-info-desc {
            font-size: 0.875rem;
            color: #64748b;
        }
        
        .hints-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .hints-subtitle {
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            margin-bottom: 0.75rem;
        }
        
        .hint-item {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            background-color: white;
        }
        
        .hint-item.selected {
            background-color: #f8fafc;
        }
        
        .hint-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .hint-name {
            font-weight: 500;
            color: #2563eb;
        }
        
        .hint-category {
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            background-color: #2563eb;
            color: white;
            border-radius: 0.25rem;
        }
        
        .hint-description {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }
        
        .hint-formula {
            font-size: 0.75rem;
            color: #2563eb;
            font-family: monospace;
            background-color: #f8fafc;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        
        .hint-details {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e2e8f0;
        }
        
        .hint-examples-title {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .hint-examples {
            font-size: 0.875rem;
            color: #64748b;
            padding-left: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .hint-examples li {
            margin-bottom: 0.25rem;
        }
        
        .btn-add-hint {
            width: 100%;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 0.75rem;
            border: none;
            cursor: pointer;
            background-color: #2563eb;
            color: white;
        }
        
        .no-hints {
            text-align: center;
            color: #64748b;
            padding: 1rem;
        }
        
        .no-hints-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }
        
        .no-hints-text {
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
        }
        
        .btn-manual-add {
            margin-top: 0.75rem;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 0.75rem;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            background-color: #f8fafc;
            color: #0f172a;
        }
        
        .hint-footer {
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            background-color: #f8fafc;
        }
        
        .hint-tip {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            max-width: 28rem;
            width: 100%;
            margin: 1rem;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin: 0;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        
        .calculation-assistant {
            background-color: #f8fafc;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        .calculation-title {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .calculation-description {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.75rem;
        }
        
        .calculation-screen {
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .calculation-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .calculation-step-title {
            font-weight: 500;
        }
        
        .calculation-step-desc {
            font-size: 0.875rem;
            color: #64748b;
        }
        
        .calculation-example {
            background-color: #dbeafe;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .calculation-example-text {
            font-size: 0.875rem;
        }
        
        .modal-footer {
            display: flex;
            gap: 0.75rem;
            padding: 1.5rem;
            border-top: 1px solid #e2e8f0;
        }
        
        .btn-flex {
            flex: 1;
        }
        
        .btn-cancel {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            background-color: #f8fafc;
            color: #0f172a;
        }
        
        .btn-save {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            background-color: #2563eb;
            color: white;
        }
        
        .btn-back {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            background-color: #f8fafc;
            color: #0f172a;
        }
        
        .btn-calculate {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            background-color: #2563eb;
            color: white;
        }
        
        .btn-calculate:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        
        .hidden {
            display: none;
        }

        /* è³ªå•ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .questionnaire-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .questionnaire-content {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            max-width: 32rem;
            width: 100%;
            margin: 1rem;
            max-height: 90vh;
            overflow-y: auto;
        }

        .questionnaire-header {
            padding: 2rem 2rem 1rem 2rem;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
        }

        .questionnaire-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .questionnaire-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #0f172a;
        }

        .questionnaire-subtitle {
            color: #64748b;
            font-size: 0.875rem;
        }

        .questionnaire-body {
            padding: 2rem;
        }

        .question-container {
            margin-bottom: 2rem;
        }

        .question-number {
            font-size: 0.875rem;
            color: #2563eb;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .question-text {
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 1rem;
            color: #0f172a;
        }

        .answer-options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .answer-option {
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: white;
        }

        .answer-option:hover {
            border-color: #2563eb;
            background-color: #f8fafc;
        }

        .answer-option.selected {
            border-color: #2563eb;
            background-color: #dbeafe;
        }

        .answer-title {
            font-weight: 500;
            color: #0f172a;
            margin-bottom: 0.25rem;
        }

        .answer-description {
            font-size: 0.875rem;
            color: #64748b;
        }

        .form-input-large {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .form-input-large:focus {
            outline: none;
            border-color: #2563eb;
        }

        .questionnaire-navigation {
            display: flex;
            justify-content: space-between;
            padding: 1.5rem 2rem;
            border-top: 1px solid #e2e8f0;
        }

        .btn-nav {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-nav-back {
            border: 1px solid #e2e8f0;
            background-color: white;
            color: #0f172a;
        }

        .btn-nav-back:hover {
            background-color: #f8fafc;
        }

        .btn-nav-next {
            border: none;
            background-color: #2563eb;
            color: white;
        }

        .btn-nav-next:hover {
            background-color: #1d4ed8;
        }

        .btn-nav-next:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        .progress-bar {
            height: 4px;
            background-color: #e2e8f0;
            margin-bottom: 2rem;
        }

        .progress-fill {
            height: 100%;
            background-color: #2563eb;
            transition: width 0.3s ease;
        }

        .generating-screen {
            text-align: center;
            padding: 3rem 2rem;
        }

        .generating-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .generating-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #0f172a;
        }

        .generating-subtitle {
            color: #64748b;
            margin-bottom: 2rem;
        }

        .generating-steps {
            text-align: left;
            max-width: 24rem;
            margin: 0 auto;
        }

        .generating-step {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: #f8fafc;
        }

        .generating-step.active {
            background-color: #dbeafe;
            border: 1px solid #2563eb;
        }

        .generating-step.completed {
            background-color: #dcfce7;
            border: 1px solid #16a34a;
        }

        .step-icon {
            margin-right: 0.75rem;
            font-size: 1.25rem;
        }

        .step-text {
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="header-left">
                <h1 class="title">ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆKPIãƒ„ãƒªãƒ¼</h1>
                <span class="subtitle" id="tree-name"></span>
            </div>
            <div class="header-buttons">
                <button class="btn btn-secondary" id="btn-settings" disabled>æ•°å€¤è¨­å®š</button>
                <button class="btn btn-primary">ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- ãƒ¡ã‚¤ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
        <div class="canvas-container">
            <div id="empty-state" class="empty-state">
                <div class="empty-content">
                    <div class="empty-icon">ğŸŒ³</div>
                    <h2 class="empty-title">KPIãƒ„ãƒªãƒ¼ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†</h2>
                    <p class="empty-text">ã„ãã¤ã‹ã®è³ªå•ã«å›ç­”ã—ã¦ã€KPIãƒ„ãƒªãƒ¼ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†</p>
                    <button class="btn-add-root" id="btn-add-root">KPIãƒ„ãƒªãƒ¼ã‚’ä½œã‚‹</button>
                </div>
            </div>
            <div id="canvas" class="canvas hidden">
                <div class="canvas-content">
                    <svg class="connections" id="connections"></svg>
                    <div id="nodes-container"></div>
                </div>
            </div>
        </div>

        <!-- ãƒ’ãƒ³ãƒˆãƒ‘ãƒãƒ« -->
        <div id="hint-panel" class="hint-panel hidden">
            <div class="hint-header">
                <h3 class="hint-title">KPIãƒ’ãƒ³ãƒˆ</h3>
                <button class="close-btn" id="close-hints">âœ•</button>
            </div>
            <div class="node-info">
                <div class="node-info-name" id="selected-node-name"></div>
                <div class="node-info-desc" id="selected-node-desc"></div>
            </div>
            <div class="hints-content">
                <div class="hints-subtitle" id="hints-subtitle"></div>
                <div id="hints-list"></div>
                <div id="no-hints" class="no-hints hidden">
                    <div class="no-hints-icon">ğŸ’¡</div>
                    <div class="no-hints-text">
                        ã“ã®KPIã®ãƒ’ãƒ³ãƒˆã¯ç¾åœ¨æº–å‚™ä¸­ã§ã™ã€‚<br/>
                        æ‰‹å‹•ã§å­KPIã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
                    </div>
                    <button class="btn-manual-add" id="btn-manual-add">æ‰‹å‹•ã§KPIã‚’è¿½åŠ </button>
                </div>
            </div>
            <div class="hint-footer">
                <div class="hint-tip">ğŸ’¡ ãƒ’ãƒ³ãƒˆ: KPIã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦åå‰ã‚’ç·¨é›†ã§ãã¾ã™</div>
            </div>
        </div>
    </div>

    <!-- è³ªå•ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="questionnaire-modal" class="questionnaire-modal hidden">
        <div class="questionnaire-content">
            <div class="questionnaire-header">
                <div class="questionnaire-icon">ğŸ¯</div>
                <h2 class="questionnaire-title">KPIãƒ„ãƒªãƒ¼ä½œæˆã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h2>
                <p class="questionnaire-subtitle">ã„ãã¤ã‹ã®è³ªå•ã«ãŠç­”ãˆã„ãŸã ãã€æœ€é©ãªKPIãƒ„ãƒªãƒ¼ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™</p>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>

            <div id="questionnaire-content">
                <!-- è³ªå•ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
            </div>

            <div class="questionnaire-navigation">
                <button class="btn-nav btn-nav-back" id="btn-prev-question" style="visibility: hidden;">æˆ»ã‚‹</button>
                <button class="btn-nav btn-nav-next" id="btn-next-question" disabled>æ¬¡ã¸</button>
            </div>
        </div>
    </div>

    <!-- ç”Ÿæˆä¸­ç”»é¢ -->
    <div id="generating-modal" class="questionnaire-modal hidden">
        <div class="questionnaire-content">
            <div class="generating-screen">
                <div class="generating-icon">âš™ï¸</div>
                <h2 class="generating-title">KPIãƒ„ãƒªãƒ¼ã‚’ç”Ÿæˆä¸­...</h2>
                <p class="generating-subtitle">å›ç­”å†…å®¹ã‚’åˆ†æã—ã€æœ€é©ãªKPIãƒ„ãƒªãƒ¼ã‚’ä½œæˆã—ã¦ã„ã¾ã™</p>
                
                <div class="generating-steps">
                    <div class="generating-step completed" id="step-analyze">
                        <div class="step-icon">âœ…</div>
                        <div class="step-text">å›ç­”å†…å®¹ã‚’åˆ†æ</div>
                    </div>
                    <div class="generating-step active" id="step-generate">
                        <div class="step-icon">âš™ï¸</div>
                        <div class="step-text">KPIãƒ„ãƒªãƒ¼ã‚’ç”Ÿæˆ</div>
                    </div>
                    <div class="generating-step" id="step-complete">
                        <div class="step-icon">ğŸŒ³</div>
                        <div class="step-text">ãƒ„ãƒªãƒ¼ã‚’è¡¨ç¤º</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ•°å€¤å…¥åŠ›ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div id="value-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">æ•°å€¤è¨­å®š</h3>
                <button class="close-btn" id="close-modal">âœ•</button>
            </div>
            <div id="value-form" class="modal-body">
                <div class="form-group">
                    <label class="form-label">ç›®æ¨™å€¤</label>
                    <input type="number" class="form-input" id="target-input" placeholder="ç›®æ¨™å€¤ã‚’å…¥åŠ›">
                </div>
                <div class="form-group">
                    <label class="form-label">å®Ÿç¸¾å€¤</label>
                    <input type="number" class="form-input" id="value-input" placeholder="ç¾åœ¨ã®å®Ÿç¸¾å€¤ã‚’å…¥åŠ›">
                </div>
                <div class="form-group">
                    <label class="form-label">å˜ä½</label>
                    <input type="text" class="form-input" id="unit-input" placeholder="ä¾‹: å††ã€ä»¶ã€äºº">
                </div>
                <div class="calculation-assistant">
                    <div class="calculation-title">ğŸ¤– ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆè¨ˆç®—</div>
                    <div class="calculation-description">ä¸Šä½KPIã®æƒ…å ±ã‹ã‚‰è‡ªå‹•çš„ã«ç›®æ¨™å€¤ã‚’ç®—å‡ºã—ã¾ã™</div>
                    <button class="btn btn-secondary" id="btn-calculation">è¨ˆç®—ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚’ä½¿ç”¨</button>
                </div>
            </div>
            <div id="calculation-form" class="modal-body hidden">
                <div class="calculation-screen">
                    <div class="calculation-icon">ğŸ§®</div>
                    <div class="calculation-step-title">ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆè¨ˆç®—</div>
                    <div class="calculation-step-desc">ã„ãã¤ã‹ã®è³ªå•ã«ãŠç­”ãˆãã ã•ã„</div>
                </div>
                <div class="form-group">
                    <label class="form-label" id="parent-question">ä¸Šä½KPIã®ç›®æ¨™å€¤ã¯ã„ãã‚‰ã§ã™ã‹ï¼Ÿ</label>
                    <input type="number" class="form-input" id="parent-value" placeholder="ä¾‹: 5000ä¸‡å††ã®å ´åˆã¯ 50000000">
                </div>
                <div class="form-group">
                    <label class="form-label" id="child-question">éå»ã®å¹³å‡å€¤ã¯ã„ãã‚‰ã§ã—ãŸã‹ï¼Ÿ</label>
                    <input type="number" class="form-input" id="child-estimate" placeholder="ä¾‹: å¹³å‡å˜ä¾¡50ä¸‡å††ã®å ´åˆã¯ 500000">
                </div>
                <div class="calculation-example">
                    <div class="calculation-example-text">ğŸ’¡ è¨ˆç®—ä¾‹: å£²ä¸Š5000ä¸‡å†† Ã· å¹³å‡å˜ä¾¡50ä¸‡å†† = ç›®æ¨™ä»¶æ•°100ä»¶</div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn-back btn-flex" id="btn-back">æˆ»ã‚‹</button>
                    <button class="btn-calculate btn-flex" id="btn-calculate" disabled>è¨ˆç®—å®Ÿè¡Œ</button>
                </div>
            </div>
            <div id="value-footer" class="modal-footer">
                <button class="btn-cancel btn-flex" id="btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-save btn-flex" id="btn-save">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // KPIãƒ’ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿
        const kpiHints = {
            'å£²ä¸Š': [
                {
                    id: 'customers',
                    name: 'é¡§å®¢æ•°',
                    description: 'å£²ä¸Šã‚’ç”Ÿã¿å‡ºã™é¡§å®¢ã®ç·æ•°ã€‚æ–°è¦ãƒ»æ—¢å­˜ã«åˆ†ã‘ã¦ç®¡ç†ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚',
                    formula: 'å£²ä¸Š = é¡§å®¢æ•° Ã— é¡§å®¢å˜ä¾¡',
                    examples: ['æœˆé–“ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°', 'å¥‘ç´„ä¼æ¥­æ•°', 'ä¼šå“¡æ•°'],
                    category: 'customer'
                },
                {
                    id: 'customer_price',
                    name: 'é¡§å®¢å˜ä¾¡',
                    description: 'ä¸€äººã®é¡§å®¢ãŒå¹³å‡çš„ã«æ”¯æ‰•ã†é‡‘é¡ã€‚LTVï¼ˆé¡§å®¢ç”Ÿæ¶¯ä¾¡å€¤ï¼‰ã®åŸºç¤ã¨ãªã‚Šã¾ã™ã€‚',
                    formula: 'å£²ä¸Š = é¡§å®¢æ•° Ã— é¡§å®¢å˜ä¾¡',
                    examples: ['ARPUï¼ˆAverage Revenue Per Userï¼‰', 'å¹³å‡æ³¨æ–‡é‡‘é¡', 'å¥‘ç´„å˜ä¾¡'],
                    category: 'revenue'
                },
                {
                    id: 'contracts',
                    name: 'æˆç´„æ•°',
                    description: 'å®Ÿéš›ã«å¥‘ç´„ã‚„è³¼å…¥ã«è‡³ã£ãŸä»¶æ•°ã€‚æˆç´„ç‡ã¨çµ„ã¿åˆã‚ã›ã¦åˆ†æã—ã¾ã™ã€‚',
                    formula: 'å£²ä¸Š = æˆç´„æ•° Ã— å¹³å‡å¥‘ç´„é‡‘é¡',
                    examples: ['æœˆé–“æˆç´„ä»¶æ•°', 'æ–°è¦å¥‘ç´„æ•°', 'ã‚ªãƒ¼ãƒ€ãƒ¼æ•°'],
                    category: 'revenue'
                },
                {
                    id: 'profit_margin',
                    name: 'åˆ©ç›Šç‡',
                    description: 'å£²ä¸Šã«å¯¾ã™ã‚‹åˆ©ç›Šã®å‰²åˆã€‚åç›Šæ€§ã‚’æ¸¬ã‚‹é‡è¦ãªæŒ‡æ¨™ã§ã™ã€‚',
                    formula: 'åˆ©ç›Šç‡ = (å£²ä¸Š - è²»ç”¨) Ã· å£²ä¸Š',
                    examples: ['ç²—åˆ©ç›Šç‡', 'å–¶æ¥­åˆ©ç›Šç‡', 'ç´”åˆ©ç›Šç‡'],
                    category: 'profitability'
                }
            ],
            'é¡§å®¢æ•°': [
                {
                    id: 'new_customers',
                    name: 'æ–°è¦é¡§å®¢æ•°',
                    description: 'æ–°ãŸã«ç²å¾—ã—ãŸé¡§å®¢ã®æ•°ã€‚æˆé•·ã®åŸå‹•åŠ›ã¨ãªã‚‹é‡è¦æŒ‡æ¨™ã§ã™ã€‚',
                    formula: 'é¡§å®¢æ•° = æ–°è¦é¡§å®¢æ•° + æ—¢å­˜é¡§å®¢æ•°',
                    examples: ['æœˆé–“æ–°è¦ç™»éŒ²æ•°', 'æ–°è¦å¥‘ç´„ä¼æ¥­æ•°', 'åˆå›è³¼å…¥è€…æ•°'],
                    category: 'customer'
                },
                {
                    id: 'existing_customers',
                    name: 'æ—¢å­˜é¡§å®¢æ•°',
                    description: 'ç¶™ç¶šåˆ©ç”¨ã—ã¦ã„ã‚‹é¡§å®¢ã®æ•°ã€‚ãƒªãƒ†ãƒ³ã‚·ãƒ§ãƒ³ç‡ã¨å¯†æ¥ã«é–¢ä¿‚ã—ã¾ã™ã€‚',
                    formula: 'é¡§å®¢æ•° = æ–°è¦é¡§å®¢æ•° + æ—¢å­˜é¡§å®¢æ•°',
                    examples: ['ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°', 'ç¶™ç¶šå¥‘ç´„æ•°', 'ãƒªãƒ”ãƒ¼ã‚¿ãƒ¼æ•°'],
                    category: 'customer'
                },
                {
                    id: 'retention_rate',
                    name: 'é¡§å®¢ç¶™ç¶šç‡',
                    description: 'æ—¢å­˜é¡§å®¢ãŒç¶™ç¶šã—ã¦åˆ©ç”¨ã—ã¦ã„ã‚‹å‰²åˆã€‚é¡§å®¢ãƒ­ã‚¤ãƒ¤ãƒ«ãƒ†ã‚£ã®æŒ‡æ¨™ã§ã™ã€‚',
                    formula: 'ç¶™ç¶šç‡ = ç¶™ç¶šé¡§å®¢æ•° Ã· æœŸåˆé¡§å®¢æ•°',
                    examples: ['æœˆæ¬¡ç¶™ç¶šç‡', 'å¹´æ¬¡ç¶™ç¶šç‡', 'ãƒãƒ£ãƒ¼ãƒ³ç‡'],
                    category: 'customer'
                }
            ],
            'æˆç´„æ•°': [
                {
                    id: 'proposals',
                    name: 'ææ¡ˆæ•°',
                    description: 'é¡§å®¢ã«å¯¾ã—ã¦è¡Œã£ãŸææ¡ˆã®æ•°ã€‚å•†è«‡æ©Ÿä¼šã®å‰µå‡ºåŠ›ã‚’è¡¨ã—ã¾ã™ã€‚',
                    formula: 'æˆç´„æ•° = ææ¡ˆæ•° Ã— ææ¡ˆæˆç´„ç‡',
                    examples: ['è¦‹ç©æå‡ºæ•°', 'ãƒ—ãƒ¬ã‚¼ãƒ³å®Ÿæ–½æ•°', 'å•†è«‡æ•°'],
                    category: 'marketing'
                },
                {
                    id: 'conversion_rate',
                    name: 'æˆç´„ç‡',
                    description: 'ææ¡ˆã‹ã‚‰æˆç´„ã«è‡³ã‚‹å‰²åˆã€‚å–¶æ¥­åŠ¹ç‡ã‚’æ¸¬ã‚‹é‡è¦ãªæŒ‡æ¨™ã§ã™ã€‚',
                    formula: 'æˆç´„ç‡ = æˆç´„æ•° Ã· ææ¡ˆæ•°',
                    examples: ['å•†è«‡æˆç´„ç‡', 'è¦‹ç©æˆç´„ç‡', 'ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°ç‡'],
                    category: 'sales'
                }
            ],
            'é¡§å®¢å˜ä¾¡': [
                {
                    id: 'purchase_frequency',
                    name: 'è³¼å…¥é »åº¦',
                    description: 'é¡§å®¢ãŒä¸€å®šæœŸé–“å†…ã«è³¼å…¥ã™ã‚‹å›æ•°ã€‚ãƒªãƒ”ãƒ¼ãƒˆæ€§ã‚’æ¸¬ã‚‹æŒ‡æ¨™ã§ã™ã€‚',
                    formula: 'é¡§å®¢å˜ä¾¡ = å¹³å‡æ³¨æ–‡é‡‘é¡ Ã— è³¼å…¥é »åº¦',
                    examples: ['æœˆé–“è³¼å…¥å›æ•°', 'å¹´é–“è³¼å…¥å›æ•°', 'ãƒªãƒ”ãƒ¼ãƒˆç‡'],
                    category: 'customer'
                },
                {
                    id: 'average_order_value',
                    name: 'å¹³å‡æ³¨æ–‡é‡‘é¡',
                    description: '1å›ã®æ³¨æ–‡ã‚ãŸã‚Šã®å¹³å‡é‡‘é¡ã€‚å®¢å˜ä¾¡ã®åŸºç¤ã¨ãªã‚‹æŒ‡æ¨™ã§ã™ã€‚',
                    formula: 'é¡§å®¢å˜ä¾¡ = å¹³å‡æ³¨æ–‡é‡‘é¡ Ã— è³¼å…¥é »åº¦',
                    examples: ['AOV', 'å®¢å˜ä¾¡', 'ãƒã‚¹ã‚±ãƒƒãƒˆå˜ä¾¡'],
                    category: 'revenue'
                }
            ],
            'æ–°è¦é¡§å®¢æ•°': [
                {
                    id: 'leads',
                    name: 'ãƒªãƒ¼ãƒ‰æ•°',
                    description: 'è¦‹è¾¼ã¿é¡§å®¢ã®ç·æ•°ã€‚ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æ´»å‹•ã®æˆæœã‚’è¡¨ã—ã¾ã™ã€‚',
                    formula: 'æ–°è¦é¡§å®¢æ•° = ãƒªãƒ¼ãƒ‰æ•° Ã— ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡',
                    examples: ['å•ã„åˆã‚ã›æ•°', 'è³‡æ–™è«‹æ±‚æ•°', 'ã‚»ãƒŸãƒŠãƒ¼å‚åŠ è€…æ•°'],
                    category: 'marketing'
                },
                {
                    id: 'conversion_from_leads',
                    name: 'ãƒªãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡',
                    description: 'ãƒªãƒ¼ãƒ‰ã‹ã‚‰é¡§å®¢ã«ãªã‚‹å‰²åˆã€‚ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã‹ã‚‰å–¶æ¥­ã¸ã®åŠ¹ç‡ã‚’è¡¨ã—ã¾ã™ã€‚',
                    formula: 'æ–°è¦é¡§å®¢æ•° = ãƒªãƒ¼ãƒ‰æ•° Ã— ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡',
                    examples: ['MQL to SQLç‡', 'SQL to Customerç‡', 'å…¨ä½“CVç‡'],
                    category: 'sales'
                }
            ],
            'ãƒªãƒ¼ãƒ‰æ•°': [
                {
                    id: 'website_visitors',
                    name: 'Webã‚µã‚¤ãƒˆè¨ªå•è€…æ•°',
                    description: 'Webã‚µã‚¤ãƒˆã¸ã®è¨ªå•è€…æ•°ã€‚ãƒ‡ã‚¸ã‚¿ãƒ«ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã®èµ·ç‚¹ã¨ãªã‚‹æŒ‡æ¨™ã§ã™ã€‚',
                    formula: 'ãƒªãƒ¼ãƒ‰æ•° = è¨ªå•è€…æ•° Ã— ãƒªãƒ¼ãƒ‰ç²å¾—ç‡',
                    examples: ['ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒ“ã‚¸ã‚¿ãƒ¼æ•°', 'ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°', 'PVæ•°'],
                    category: 'marketing'
                },
                {
                    id: 'lead_acquisition_rate',
                    name: 'ãƒªãƒ¼ãƒ‰ç²å¾—ç‡',
                    description: 'ã‚µã‚¤ãƒˆè¨ªå•è€…ãŒãƒªãƒ¼ãƒ‰ã«ãªã‚‹å‰²åˆã€‚ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®é­…åŠ›åº¦ã‚’è¡¨ã—ã¾ã™ã€‚',
                    formula: 'ãƒªãƒ¼ãƒ‰æ•° = è¨ªå•è€…æ•° Ã— ãƒªãƒ¼ãƒ‰ç²å¾—ç‡',
                    examples: ['ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ç‡', 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç‡', 'ãƒ¡ãƒ«ãƒã‚¬ç™»éŒ²ç‡'],
                    category: 'marketing'
                }
            ],
            'ææ¡ˆæ•°': [
                {
                    id: 'qualified_leads',
                    name: 'æœ‰åŠ¹ãƒªãƒ¼ãƒ‰æ•°',
                    description: 'å–¶æ¥­æ´»å‹•ã«å€¤ã™ã‚‹è³ªã®é«˜ã„ãƒªãƒ¼ãƒ‰æ•°ã€‚å–¶æ¥­åŠ¹ç‡ã«ç›´çµã—ã¾ã™ã€‚',
                    formula: 'ææ¡ˆæ•° = æœ‰åŠ¹ãƒªãƒ¼ãƒ‰æ•° Ã— ææ¡ˆç‡',
                    examples: ['SQLæ•°', 'BANTãƒªãƒ¼ãƒ‰æ•°', 'ãƒ›ãƒƒãƒˆãƒªãƒ¼ãƒ‰æ•°'],
                    category: 'sales'
                },
                {
                    id: 'proposal_rate',
                    name: 'ææ¡ˆç‡',
                    description: 'æœ‰åŠ¹ãƒªãƒ¼ãƒ‰ã‹ã‚‰ææ¡ˆã«è‡³ã‚‹å‰²åˆã€‚å–¶æ¥­ãƒ—ãƒ­ã‚»ã‚¹ã®åŠ¹ç‡ã‚’è¡¨ã—ã¾ã™ã€‚',
                    formula: 'ææ¡ˆæ•° = æœ‰åŠ¹ãƒªãƒ¼ãƒ‰æ•° Ã— ææ¡ˆç‡',
                    examples: ['å•†è«‡åŒ–ç‡', 'ãƒ‹ãƒ¼ã‚ºãƒ’ã‚¢ãƒªãƒ³ã‚°ç‡', 'ãƒ‡ãƒ¢å®Ÿæ–½ç‡'],
                    category: 'sales'
                }
            ],
            'åˆ©ç›Šç‡': [
                {
                    id: 'cost_of_sales',
                    name: 'å£²ä¸ŠåŸä¾¡ç‡',
                    description: 'å£²ä¸Šã«å¯¾ã™ã‚‹åŸä¾¡ã®å‰²åˆã€‚å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã®åŸä¾¡åŠ¹ç‡ã‚’è¡¨ã—ã¾ã™ã€‚',
                    formula: 'åˆ©ç›Šç‡ = 1 - (å£²ä¸ŠåŸä¾¡ç‡ + è²©ç®¡è²»ç‡)',
                    examples: ['åŸææ–™è²»ç‡', 'è£½é€ è²»ç‡', 'ä»•å…¥åŸä¾¡ç‡'],
                    category: 'cost'
                },
                {
                    id: 'operating_expense_ratio',
                    name: 'è²©ç®¡è²»ç‡',
                    description: 'å£²ä¸Šã«å¯¾ã™ã‚‹è²©å£²ç®¡ç†è²»ã®å‰²åˆã€‚é‹å–¶åŠ¹ç‡ã‚’è¡¨ã—ã¾ã™ã€‚',
                    formula: 'åˆ©ç›Šç‡ = 1 - (å£²ä¸ŠåŸä¾¡ç‡ + è²©ç®¡è²»ç‡)',
                    examples: ['äººä»¶è²»ç‡', 'åºƒå‘Šè²»ç‡', 'ä¸€èˆ¬ç®¡ç†è²»ç‡'],
                    category: 'cost'
                }
            ],
            'Webã‚µã‚¤ãƒˆè¨ªå•è€…æ•°': [
                {
                    id: 'organic_traffic',
                    name: 'ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯æµå…¥',
                    description: 'æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã‹ã‚‰ã®è‡ªç„¶æµå…¥ã€‚SEOåŠ¹æœã‚’æ¸¬ã‚‹æŒ‡æ¨™ã§ã™ã€‚',
                    formula: 'è¨ªå•è€…æ•° = ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯æµå…¥ + æœ‰æ–™æµå…¥ + ãã®ä»–æµå…¥',
                    examples: ['Googleæ¤œç´¢æµå…¥', 'Yahooæ¤œç´¢æµå…¥', 'SEOæµå…¥'],
                    category: 'marketing'
                },
                {
                    id: 'paid_traffic',
                    name: 'æœ‰æ–™åºƒå‘Šæµå…¥',
                    description: 'åºƒå‘Šã‹ã‚‰ã®æµå…¥ã€‚åºƒå‘ŠæŠ•è³‡ã®åŠ¹æœã‚’è¡¨ã—ã¾ã™ã€‚',
                    formula: 'è¨ªå•è€…æ•° = ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯æµå…¥ + æœ‰æ–™æµå…¥ + ãã®ä»–æµå…¥',
                    examples: ['Googleåºƒå‘Šæµå…¥', 'Facebookåºƒå‘Šæµå…¥', 'ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤åºƒå‘Šæµå…¥'],
                    category: 'marketing'
                },
                {
                    id: 'referral_traffic',
                    name: 'å‚ç…§ã‚µã‚¤ãƒˆæµå…¥',
                    description: 'ä»–ã‚µã‚¤ãƒˆã‹ã‚‰ã®æµå…¥ã€‚å¤–éƒ¨é€£æºã‚„PRåŠ¹æœã‚’è¡¨ã—ã¾ã™ã€‚',
                    formula: 'è¨ªå•è€…æ•° = ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯æµå…¥ + æœ‰æ–™æµå…¥ + ãã®ä»–æµå…¥',
                    examples: ['SNSæµå…¥', 'ãƒ¡ãƒ‡ã‚£ã‚¢æ²è¼‰æµå…¥', 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚µã‚¤ãƒˆæµå…¥'],
                    category: 'marketing'
                }
            ]
        };

        // è³ªå•ãƒ‡ãƒ¼ã‚¿
        const questionnaire = [
            {
                id: 'business_type',
                type: 'choice',
                question: 'ã‚ãªãŸã®ãƒ“ã‚¸ãƒã‚¹ã‚¿ã‚¤ãƒ—ã‚’æ•™ãˆã¦ãã ã•ã„',
                options: [
                    {
                        value: 'ecommerce',
                        title: 'Eã‚³ãƒãƒ¼ã‚¹ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è²©å£²',
                        description: 'å•†å“ã‚’ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§è²©å£²ã—ã¦ã„ã‚‹'
                    },
                    {
                        value: 'saas',
                        title: 'SaaSãƒ»ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚µãƒ¼ãƒ“ã‚¹',
                        description: 'ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å‹ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’æä¾›'
                    },
                    {
                        value: 'retail',
                        title: 'å°å£²ãƒ»å®Ÿåº—èˆ—',
                        description: 'å®Ÿåº—èˆ—ã§å•†å“ã‚’è²©å£²ã—ã¦ã„ã‚‹'
                    },
                    {
                        value: 'service',
                        title: 'ã‚µãƒ¼ãƒ“ã‚¹æ¥­ãƒ»ã‚³ãƒ³ã‚µãƒ«ãƒ†ã‚£ãƒ³ã‚°',
                        description: 'ç„¡å½¢ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã—ã¦ã„ã‚‹'
                    },
                    {
                        value: 'manufacturing',
                        title: 'è£½é€ æ¥­',
                        description: 'å•†å“ã‚’è£½é€ ãƒ»ç”Ÿç”£ã—ã¦ã„ã‚‹'
                    },
                    {
                        value: 'other',
                        title: 'ãã®ä»–',
                        description: 'ä¸Šè¨˜ã«å½“ã¦ã¯ã¾ã‚‰ãªã„æ¥­ç¨®'
                    }
                ]
            },
            {
                id: 'primary_goal',
                type: 'choice',
                question: 'ç¾åœ¨ã®ä¸»è¦ãªçµŒå–¶ç›®æ¨™ã¯ä½•ã§ã™ã‹ï¼Ÿ',
                options: [
                    {
                        value: 'revenue_growth',
                        title: 'å£²ä¸Šãƒ»åç›Šã®å¢—åŠ ',
                        description: 'å£²ä¸Šã‚’æ‹¡å¤§ã—ãŸã„'
                    },
                    {
                        value: 'customer_acquisition',
                        title: 'æ–°è¦é¡§å®¢ã®ç²å¾—',
                        description: 'é¡§å®¢æ•°ã‚’å¢—ã‚„ã—ãŸã„'
                    },
                    {
                        value: 'customer_retention',
                        title: 'æ—¢å­˜é¡§å®¢ã®ç¶­æŒ',
                        description: 'é¡§å®¢ã®ç¶™ç¶šç‡ã‚’é«˜ã‚ãŸã„'
                    },
                    {
                        value: 'efficiency',
                        title: 'æ¥­å‹™åŠ¹ç‡ã®æ”¹å–„',
                        description: 'ã‚³ã‚¹ãƒˆã‚’å‰Šæ¸›ã—åŠ¹ç‡ã‚’ä¸Šã’ãŸã„'
                    },
                    {
                        value: 'market_expansion',
                        title: 'å¸‚å ´æ‹¡å¤§ãƒ»æ–°è¦äº‹æ¥­',
                        description: 'æ–°ã—ã„å¸‚å ´ã‚„äº‹æ¥­ã«é€²å‡ºã—ãŸã„'
                    }
                ]
            },
            {
                id: 'company_stage',
                type: 'choice',
                question: 'ä¼šç¤¾ã®æˆé•·ã‚¹ãƒ†ãƒ¼ã‚¸ã¯ã©ã‚Œã«å½“ã¦ã¯ã¾ã‚Šã¾ã™ã‹ï¼Ÿ',
                options: [
                    {
                        value: 'startup',
                        title: 'ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ï¼ˆå‰µæ¥­æœŸï¼‰',
                        description: 'äº‹æ¥­ã‚’ç«‹ã¡ä¸Šã’ãŸã°ã‹ã‚Š'
                    },
                    {
                        value: 'growth',
                        title: 'æˆé•·æœŸ',
                        description: 'äº‹æ¥­ãŒè»Œé“ã«ä¹—ã‚Šæ‹¡å¤§ä¸­'
                    },
                    {
                        value: 'mature',
                        title: 'æˆç†ŸæœŸ',
                        description: 'å®‰å®šã—ãŸåç›ŠåŸºç›¤ãŒã‚ã‚‹'
                    },
                    {
                        value: 'transformation',
                        title: 'å¤‰é©æœŸ',
                        description: 'ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«ã‚’å¤‰åŒ–ã•ã›ã¦ã„ã‚‹'
                    }
                ]
            },
            {
                id: 'team_size',
                type: 'choice',
                question: 'ãƒãƒ¼ãƒ ãƒ»çµ„ç¹”ã®è¦æ¨¡ã‚’æ•™ãˆã¦ãã ã•ã„',
                options: [
                    {
                        value: 'solo',
                        title: 'å€‹äººäº‹æ¥­ãƒ»1äºº',
                        description: 'ä¸€äººã§äº‹æ¥­ã‚’é‹å–¶'
                    },
                    {
                        value: 'small',
                        title: 'å°è¦æ¨¡ãƒãƒ¼ãƒ ï¼ˆ2-10äººï¼‰',
                        description: 'å°‘æ•°ç²¾é‹­ã®ãƒãƒ¼ãƒ '
                    },
                    {
                        value: 'medium',
                        title: 'ä¸­è¦æ¨¡çµ„ç¹”ï¼ˆ11-50äººï¼‰',
                        description: 'éƒ¨é–€ãŒåˆ†ã‹ã‚Œå§‹ã‚ã¦ã„ã‚‹'
                    },
                    {
                        value: 'large',
                        title: 'å¤§è¦æ¨¡çµ„ç¹”ï¼ˆ51äººä»¥ä¸Šï¼‰',
                        description: 'è¤‡æ•°éƒ¨é–€ãŒã‚ã‚‹çµ„ç¹”'
                    }
                ]
            },
            {
                id: 'timeframe',
                type: 'choice',
                question: 'KPIã§ç®¡ç†ã—ãŸã„æœŸé–“ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ',
                options: [
                    {
                        value: 'monthly',
                        title: 'æœˆæ¬¡ç®¡ç†',
                        description: 'æ¯æœˆã®é€²æ—ã‚’ç´°ã‹ãç®¡ç†ã—ãŸã„'
                    },
                    {
                        value: 'quarterly',
                        title: 'å››åŠæœŸç®¡ç†',
                        description: '3ãƒ¶æœˆå˜ä½ã§ç®¡ç†ã—ãŸã„'
                    },
                    {
                        value: 'annual',
                        title: 'å¹´æ¬¡ç®¡ç†',
                        description: 'å¹´å˜ä½ã§ã®ç›®æ¨™ç®¡ç†ã‚’ã—ãŸã„'
                    }
                ]
            },
            {
                id: 'specific_focus',
                type: 'text',
                question: 'ç‰¹ã«é‡è¦–ã—ãŸã„æŒ‡æ¨™ã‚„æ”¹å–„ã—ãŸã„èª²é¡ŒãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„',
                placeholder: 'ä¾‹ï¼šé¡§å®¢å˜ä¾¡ã‚’ä¸Šã’ãŸã„ã€é›¢è„±ç‡ã‚’ä¸‹ã’ãŸã„ã€æ–°è¦ãƒãƒ£ãƒãƒ«ã‚’é–‹æ‹“ã—ãŸã„ ãªã©'
            }
        ];

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
        let kpiTree = null;
        let selectedNode = null;
        let draggedNode = null;
        let dragOffset = { x: 0, y: 0 };
        let selectedHintId = null;
        let calculationStep = 0;
        let calculationData = { parentValue: '', childEstimate: '' };
        
        // è³ªå•ãƒ•ãƒ­ãƒ¼é–¢é€£ã®çŠ¶æ…‹
        let currentQuestionIndex = 0;
        let questionnaireAnswers = {};
        let isQuestionnairMode = false;

        // DOMè¦ç´ ã®å–å¾—
        const elements = {
            emptyState: document.getElementById('empty-state'),
            canvas: document.getElementById('canvas'),
            nodesContainer: document.getElementById('nodes-container'),
            connections: document.getElementById('connections'),
            hintPanel: document.getElementById('hint-panel'),
            valueModal: document.getElementById('value-modal'),
            treeName: document.getElementById('tree-name'),
            btnAddRoot: document.getElementById('btn-add-root'),
            btnSettings: document.getElementById('btn-settings'),
            closeHints: document.getElementById('close-hints'),
            closeModal: document.getElementById('close-modal'),
            selectedNodeName: document.getElementById('selected-node-name'),
            selectedNodeDesc: document.getElementById('selected-node-desc'),
            hintsSubtitle: document.getElementById('hints-subtitle'),
            hintsList: document.getElementById('hints-list'),
            noHints: document.getElementById('no-hints'),
            btnManualAdd: document.getElementById('btn-manual-add'),
            modalTitle: document.getElementById('modal-title'),
            valueForm: document.getElementById('value-form'),
            calculationForm: document.getElementById('calculation-form'),
            valueFooter: document.getElementById('value-footer'),
            targetInput: document.getElementById('target-input'),
            valueInput: document.getElementById('value-input'),
            unitInput: document.getElementById('unit-input'),
            btnCalculation: document.getElementById('btn-calculation'),
            parentQuestion: document.getElementById('parent-question'),
            childQuestion: document.getElementById('child-question'),
            parentValue: document.getElementById('parent-value'),
            childEstimate: document.getElementById('child-estimate'),
            btnBack: document.getElementById('btn-back'),
            btnCalculate: document.getElementById('btn-calculate'),
            btnCancel: document.getElementById('btn-cancel'),
            btnSave: document.getElementById('btn-save'),
            
            // è³ªå•ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
            questionnaireModal: document.getElementById('questionnaire-modal'),
            generatingModal: document.getElementById('generating-modal'),
            questionnaireContent: document.getElementById('questionnaire-content'),
            progressFill: document.getElementById('progress-fill'),
            btnPrevQuestion: document.getElementById('btn-prev-question'),
            btnNextQuestion: document.getElementById('btn-next-question')
        };

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function generateId() {
            return 'node-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        function getCategoryLabel(category) {
            const labels = { 
                customer: 'é¡§å®¢', 
                revenue: 'å£²ä¸Š', 
                marketing: 'ãƒãƒ¼ã‚±', 
                sales: 'å–¶æ¥­',
                profitability: 'åç›Šæ€§',
                cost: 'ã‚³ã‚¹ãƒˆ'
            };
            return labels[category] || category;
        }

        // è³ªå•ãƒ•ãƒ­ãƒ¼é–¢æ•°
        function startQuestionnaire() {
            isQuestionnairMode = true;
            currentQuestionIndex = 0;
            questionnaireAnswers = {};
            
            elements.questionnaireModal.classList.remove('hidden');
            showQuestion(currentQuestionIndex);
        }

        function showQuestion(index) {
            const question = questionnaire[index];
            const progress = ((index + 1) / questionnaire.length) * 100;
            
            elements.progressFill.style.width = progress + '%';
            
            if (question.type === 'choice') {
                renderChoiceQuestion(question, index);
            } else if (question.type === 'text') {
                renderTextQuestion(question, index);
            }
            
            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
            elements.btnPrevQuestion.style.visibility = index > 0 ? 'visible' : 'hidden';
            elements.btnNextQuestion.textContent = index === questionnaire.length - 1 ? 'KPIãƒ„ãƒªãƒ¼ã‚’ç”Ÿæˆ' : 'æ¬¡ã¸';
            updateNextButton();
        }

        function renderChoiceQuestion(question, index) {
            const options = question.options.map(option => `
                <div class="answer-option" data-value="${option.value}">
                    <div class="answer-title">${option.title}</div>
                    <div class="answer-description">${option.description}</div>
                </div>
            `).join('');

            elements.questionnaireContent.innerHTML = `
                <div class="questionnaire-body">
                    <div class="question-container">
                        <div class="question-number">è³ªå• ${index + 1} / ${questionnaire.length}</div>
                        <div class="question-text">${question.question}</div>
                        <div class="answer-options">
                            ${options}
                        </div>
                    </div>
                </div>
            `;

            // é¸æŠè‚¢ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            const answerOptions = elements.questionnaireContent.querySelectorAll('.answer-option');
            answerOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // ä»–ã®é¸æŠè‚¢ã®é¸æŠã‚’è§£é™¤
                    answerOptions.forEach(opt => opt.classList.remove('selected'));
                    // ç¾åœ¨ã®é¸æŠè‚¢ã‚’é¸æŠ
                    option.classList.add('selected');
                    // å›ç­”ã‚’ä¿å­˜
                    questionnaireAnswers[question.id] = option.dataset.value;
                    updateNextButton();
                });
            });

            // æ—¢å­˜ã®å›ç­”ãŒã‚ã‚Œã°å¾©å…ƒ
            if (questionnaireAnswers[question.id]) {
                const selectedOption = elements.questionnaireContent.querySelector(`[data-value="${questionnaireAnswers[question.id]}"]`);
                if (selectedOption) {
                    selectedOption.classList.add('selected');
                }
            }
        }

        function renderTextQuestion(question, index) {
            elements.questionnaireContent.innerHTML = `
                <div class="questionnaire-body">
                    <div class="question-container">
                        <div class="question-number">è³ªå• ${index + 1} / ${questionnaire.length}</div>
                        <div class="question-text">${question.question}</div>
                        <input type="text" class="form-input-large" id="text-answer" 
                               placeholder="${question.placeholder || ''}" 
                               value="${questionnaireAnswers[question.id] || ''}">
                    </div>
                </div>
            `;

            const textInput = document.getElementById('text-answer');
            textInput.addEventListener('input', () => {
                questionnaireAnswers[question.id] = textInput.value;
                updateNextButton();
            });
        }

        function updateNextButton() {
            const currentQuestion = questionnaire[currentQuestionIndex];
            const hasAnswer = questionnaireAnswers[currentQuestion.id];
            
            if (currentQuestion.type === 'choice') {
                elements.btnNextQuestion.disabled = !hasAnswer;
            } else if (currentQuestion.type === 'text') {
                // ãƒ†ã‚­ã‚¹ãƒˆè³ªå•ã¯ä»»æ„å›ç­”ãªã®ã§å¸¸ã«æœ‰åŠ¹
                elements.btnNextQuestion.disabled = false;
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < questionnaire.length - 1) {
                currentQuestionIndex++;
                showQuestion(currentQuestionIndex);
            } else {
                // æœ€å¾Œã®è³ªå•ã®å ´åˆã€KPIãƒ„ãƒªãƒ¼ã‚’ç”Ÿæˆ
                generateKPITree();
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion(currentQuestionIndex);
            }
        }

        function generateKPITree() {
            // è³ªå•ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éš ã—ã¦ç”Ÿæˆä¸­ç”»é¢ã‚’è¡¨ç¤º
            elements.questionnaireModal.classList.add('hidden');
            elements.generatingModal.classList.remove('hidden');

            // ç”Ÿæˆã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            setTimeout(() => {
                document.getElementById('step-generate').classList.remove('active');
                document.getElementById('step-generate').classList.add('completed');
                document.getElementById('step-complete').classList.add('active');
                
                setTimeout(() => {
                    document.getElementById('step-complete').classList.remove('active');
                    document.getElementById('step-complete').classList.add('completed');
                    
                    // å®Ÿéš›ã®KPIãƒ„ãƒªãƒ¼ç”Ÿæˆ
                    const generatedTree = createKPITreeFromAnswers(questionnaireAnswers);
                    
                    setTimeout(() => {
                        elements.generatingModal.classList.add('hidden');
                        displayGeneratedTree(generatedTree);
                    }, 1000);
                }, 1500);
            }, 2000);
        }

        function createKPITreeFromAnswers(answers) {
            // å›ç­”ã«åŸºã¥ã„ã¦KPIãƒ„ãƒªãƒ¼ã‚’ç”Ÿæˆ
            const businessType = answers.business_type;
            const primaryGoal = answers.primary_goal;
            const companyStage = answers.company_stage;
            
            // ãƒ“ã‚¸ãƒã‚¹ã‚¿ã‚¤ãƒ—ã«åŸºã¥ãåŸºæœ¬æ§‹é€ 
            const treeTemplates = {
                ecommerce: {
                    root: { name: 'å£²ä¸Š', description: 'Eã‚³ãƒãƒ¼ã‚¹ã®ç·å£²ä¸Š' },
                    level1: [
                        { name: 'é¡§å®¢æ•°', description: 'è³¼å…¥é¡§å®¢ã®ç·æ•°' },
                        { name: 'é¡§å®¢å˜ä¾¡', description: 'é¡§å®¢ã‚ãŸã‚Šã®å¹³å‡è³¼å…¥é‡‘é¡' }
                    ]
                },
                saas: {
                    root: { name: 'ARR', description: 'å¹´é–“çµŒå¸¸åç›Š' },
                    level1: [
                        { name: 'æ–°è¦é¡§å®¢æ•°', description: 'æ–°è¦ç²å¾—é¡§å®¢æ•°' },
                        { name: 'ARPU', description: 'é¡§å®¢ã‚ãŸã‚Šå¹³å‡åç›Š' },
                        { name: 'ç¶™ç¶šç‡', description: 'é¡§å®¢ç¶™ç¶šç‡' }
                    ]
                },
                retail: {
                    root: { name: 'å£²ä¸Š', description: 'åº—èˆ—ç·å£²ä¸Š' },
                    level1: [
                        { name: 'æ¥åº—å®¢æ•°', description: 'åº—èˆ—ã¸ã®æ¥å®¢æ•°' },
                        { name: 'å®¢å˜ä¾¡', description: '1å›ã‚ãŸã‚Šã®è³¼å…¥é‡‘é¡' }
                    ]
                },
                service: {
                    root: { name: 'å£²ä¸Š', description: 'ã‚µãƒ¼ãƒ“ã‚¹å£²ä¸Š' },
                    level1: [
                        { name: 'ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ•°', description: 'å¥‘ç´„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ•°' },
                        { name: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå˜ä¾¡', description: '1ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚ãŸã‚Šã®å˜ä¾¡' }
                    ]
                },
                manufacturing: {
                    root: { name: 'å£²ä¸Š', description: 'è£½å“å£²ä¸Š' },
                    level1: [
                        { name: 'ç”Ÿç”£é‡', description: 'è£½å“ç”Ÿç”£æ•°' },
                        { name: 'è£½å“å˜ä¾¡', description: 'è£½å“ã‚ãŸã‚Šã®å¹³å‡å˜ä¾¡' }
                    ]
                },
                other: {
                    root: { name: 'å£²ä¸Š', description: 'ãƒ“ã‚¸ãƒã‚¹å£²ä¸Š' },
                    level1: [
                        { name: 'é¡§å®¢æ•°', description: 'é¡§å®¢ã®ç·æ•°' },
                        { name: 'é¡§å®¢å˜ä¾¡', description: 'é¡§å®¢ã‚ãŸã‚Šã®å¹³å‡å˜ä¾¡' }
                    ]
                }
            };

            const template = treeTemplates[businessType] || treeTemplates.other;
            
            // ä¸»è¦ç›®æ¨™ã«åŸºã¥ãèª¿æ•´
            if (primaryGoal === 'customer_acquisition') {
                template.level1.unshift({ name: 'ãƒªãƒ¼ãƒ‰æ•°', description: 'è¦‹è¾¼ã¿é¡§å®¢æ•°' });
            } else if (primaryGoal === 'efficiency') {
                template.level1.push({ name: 'åˆ©ç›Šç‡', description: 'å£²ä¸Šåˆ©ç›Šç‡' });
            }

            return template;
        }

        function displayGeneratedTree(treeTemplate) {
            // ç”Ÿæˆã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰KPIãƒ„ãƒªãƒ¼ã‚’æ§‹ç¯‰
            const rootNode = {
                id: 'root',
                name: treeTemplate.root.name,
                level: 0,
                x: 400,
                y: 100,
                children: [],
                description: treeTemplate.root.description
            };

            const nodes = { root: rootNode };

            // ãƒ¬ãƒ™ãƒ«1ã®ãƒãƒ¼ãƒ‰ã‚’è¿½åŠ 
            treeTemplate.level1.forEach((kpi, index) => {
                const childId = `node-level1-${index}`;
                const childNode = {
                    id: childId,
                    name: kpi.name,
                    level: 1,
                    x: 200 + (index * 250),
                    y: 250,
                    children: [],
                    parent: 'root',
                    description: kpi.description
                };
                
                nodes[childId] = childNode;
                rootNode.children.push(childId);
            });

            kpiTree = {
                id: 'generated-tree',
                name: 'AIç”ŸæˆKPIãƒ„ãƒªãƒ¼',
                nodes: nodes,
                rootNodeId: 'root'
            };

            selectedNode = rootNode;
            isQuestionnairMode = false;
            
            renderTree();
            showHints();
            
            elements.treeName.textContent = kpiTree.name;
            elements.btnSettings.disabled = false;
        }

        // KPIãƒ„ãƒªãƒ¼æ“ä½œé–¢æ•°
        function addRootNode() {
            const rootNode = {
                id: 'root',
                name: 'å£²ä¸Š',
                level: 0,
                x: 400,
                y: 100,
                children: [],
                description: 'ãƒ“ã‚¸ãƒã‚¹ã®ä¸»è¦ç›®æ¨™æŒ‡æ¨™'
            };

            kpiTree = {
                id: 'tree-1',
                name: 'æ–°è¦KPIãƒ„ãƒªãƒ¼',
                nodes: { root: rootNode },
                rootNodeId: 'root'
            };

            selectedNode = rootNode;
            renderTree();
            showHints();
            
            elements.treeName.textContent = kpiTree.name;
            elements.btnSettings.disabled = false;
        }

        function addChildNode(parentId, childData) {
            if (!kpiTree) return;

            const childId = generateId();
            const parentNode = kpiTree.nodes[parentId];
            
            const childNode = {
                id: childId,
                name: childData.name || 'æ–°ã—ã„KPI',
                level: parentNode.level + 1,
                x: parentNode.x + (parentNode.children.length * 200) - 100,
                y: parentNode.y + 150,
                children: [],
                parent: parentId,
                description: childData.description,
                formula: childData.formula
            };

            parentNode.children.push(childId);
            kpiTree.nodes[childId] = childNode;

            selectedNode = childNode;
            renderTree();
            showHints();
        }

        function updateNode(nodeId, updates) {
            if (!kpiTree || !kpiTree.nodes[nodeId]) return;
            
            Object.assign(kpiTree.nodes[nodeId], updates);
            renderTree();
        }

        function deleteNode(nodeId) {
            if (!kpiTree || !kpiTree.nodes[nodeId] || nodeId === 'root') return;
            
            const node = kpiTree.nodes[nodeId];
            
            // å­ãƒãƒ¼ãƒ‰ã‚’å†å¸°çš„ã«å‰Šé™¤
            if (node.children && node.children.length > 0) {
                [...node.children].forEach(childId => deleteNode(childId));
            }
            
            // è¦ªãƒãƒ¼ãƒ‰ã‹ã‚‰è‡ªåˆ†ã‚’å‰Šé™¤
            if (node.parent && kpiTree.nodes[node.parent]) {
                const parentNode = kpiTree.nodes[node.parent];
                parentNode.children = parentNode.children.filter(childId => childId !== nodeId);
            }
            
            // ãƒãƒ¼ãƒ‰ã‚’å‰Šé™¤
            delete kpiTree.nodes[nodeId];
            
            // é¸æŠã•ã‚Œã¦ã„ãŸãƒãƒ¼ãƒ‰ãŒå‰Šé™¤ã•ã‚ŒãŸå ´åˆ
            if (selectedNode && selectedNode.id === nodeId) {
                selectedNode = null;
                elements.hintPanel.classList.add('hidden');
                elements.btnSettings.disabled = true;
            }
            
            renderTree();
        }

        function selectNode(node) {
            selectedNode = node;
            renderTree();
            showHints();
        }

        // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°
        function renderTree() {
            if (!kpiTree || Object.keys(kpiTree.nodes).length === 0) {
                elements.emptyState.classList.remove('hidden');
                elements.canvas.classList.add('hidden');
                elements.hintPanel.classList.add('hidden');
                return;
            }

            elements.emptyState.classList.add('hidden');
            elements.canvas.classList.remove('hidden');

            renderConnections();
            renderNodes();
        }

        function renderConnections() {
            const svg = elements.connections;
            svg.innerHTML = '';

            Object.values(kpiTree.nodes).forEach(parent => {
                parent.children.forEach(childId => {
                    const child = kpiTree.nodes[childId];
                    if (!child) return;

                    const parentCenterX = parent.x + 100;
                    const parentCenterY = parent.y + 40;
                    const childCenterX = child.x + 100;
                    const childCenterY = child.y + 40;

                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', parentCenterX);
                    line.setAttribute('y1', parentCenterY);
                    line.setAttribute('x2', childCenterX);
                    line.setAttribute('y2', childCenterY);
                    line.setAttribute('stroke', '#e2e8f0');
                    line.setAttribute('stroke-width', '2');

                    const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                    arrow.setAttribute('points', `${childCenterX-5},${childCenterY-5} ${childCenterX+5},${childCenterY-5} ${childCenterX},${childCenterY+5}`);
                    arrow.setAttribute('fill', '#e2e8f0');

                    svg.appendChild(line);
                    svg.appendChild(arrow);
                });
            });
        }

        function renderNodes() {
            const container = elements.nodesContainer;
            container.innerHTML = '';

            Object.values(kpiTree.nodes).forEach(node => {
                const nodeElement = createNodeElement(node);
                container.appendChild(nodeElement);
            });
        }

        function createNodeElement(node) {
            const isSelected = selectedNode?.id === node.id;
            
            const nodeDiv = document.createElement('div');
            nodeDiv.className = `node ${isSelected ? 'selected' : ''}`;
            nodeDiv.style.left = node.x + 'px';
            nodeDiv.style.top = node.y + 'px';

            const values = [];
            if (node.value) values.push(`<div class="node-value">å®Ÿç¸¾: ${node.value}${node.unit || ''}</div>`);
            if (node.target) values.push(`<div class="node-target">ç›®æ¨™: ${node.target}${node.unit || ''}</div>`);

            nodeDiv.innerHTML = `
                <div class="node-content">
                    <div class="node-name">${node.name}</div>
                    ${node.description ? `<div class="node-description">${node.description}</div>` : ''}
                    ${values.length > 0 ? `<div class="node-values">${values.join('')}</div>` : ''}
                    ${node.formula ? `<div class="node-formula">${node.formula}</div>` : ''}
                </div>
                <button class="add-child-btn" title="å­KPIã‚’è¿½åŠ ">+</button>
                ${node.id !== 'root' ? '<button class="delete-btn" title="KPIã‚’å‰Šé™¤">ğŸ—‘ï¸</button>' : ''}
            `;

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            nodeDiv.addEventListener('click', () => selectNode(node));
            nodeDiv.addEventListener('dblclick', () => editNodeName(node));
            nodeDiv.addEventListener('mousedown', (e) => startDrag(e, node.id));

            const addBtn = nodeDiv.querySelector('.add-child-btn');
            addBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const name = prompt('KPIåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
                if (name) {
                    addChildNode(node.id, { name });
                }
            });

            const deleteBtn = nodeDiv.querySelector('.delete-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`ã€Œ${node.name}ã€ã¨ãã®å­KPIã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        deleteNode(node.id);
                    }
                });
            }

            return nodeDiv;
        }

        // ãƒ’ãƒ³ãƒˆãƒ‘ãƒãƒ«é–¢æ•°
        function showHints() {
            if (!selectedNode) {
                elements.hintPanel.classList.add('hidden');
                return;
            }

            elements.hintPanel.classList.remove('hidden');
            elements.selectedNodeName.textContent = selectedNode.name;
            elements.selectedNodeDesc.textContent = selectedNode.description || '';
            elements.hintsSubtitle.textContent = `ã€Œ${selectedNode.name}ã€ã®ä¸‹ä½KPIå€™è£œ:`;

            const hints = kpiHints[selectedNode.name] || [];
            renderHints(hints);
        }

        function renderHints(hints) {
            const container = elements.hintsList;
            container.innerHTML = '';

            if (hints.length === 0) {
                elements.noHints.classList.remove('hidden');
                return;
            }

            elements.noHints.classList.add('hidden');

            hints.forEach(hint => {
                const hintElement = createHintElement(hint);
                container.appendChild(hintElement);
            });
        }

        function createHintElement(hint) {
            const isSelected = selectedHintId === hint.id;
            
            const hintDiv = document.createElement('div');
            hintDiv.className = `hint-item ${isSelected ? 'selected' : ''}`;

            const examples = hint.examples.map(ex => `<li>${ex}</li>`).join('');

            hintDiv.innerHTML = `
                <div class="hint-header-row">
                    <div class="hint-name">${hint.name}</div>
                    <div class="hint-category">${getCategoryLabel(hint.category)}</div>
                </div>
                <div class="hint-description">${hint.description}</div>
                <div class="hint-formula">${hint.formula}</div>
                ${isSelected ? `
                    <div class="hint-details">
                        <div class="hint-examples-title">å…·ä½“ä¾‹:</div>
                        <ul class="hint-examples">${examples}</ul>
                        <button class="btn-add-hint">ã“ã®KPIã‚’è¿½åŠ </button>
                    </div>
                ` : ''}
            `;

            hintDiv.addEventListener('click', () => {
                selectedHintId = selectedHintId === hint.id ? null : hint.id;
                renderHints(kpiHints[selectedNode.name] || []);
            });

            if (isSelected) {
                const addBtn = hintDiv.querySelector('.btn-add-hint');
                addBtn.addEventListener('click', () => {
                    addChildNode(selectedNode.id, hint);
                    selectedHintId = null;
                });
            }

            return hintDiv;
        }

        // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½
        function startDrag(e, nodeId) {
            draggedNode = nodeId;
            const rect = e.currentTarget.getBoundingClientRect();
            dragOffset = {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        function handleMouseMove(e) {
            if (!draggedNode) return;
            
            const rect = elements.canvas.getBoundingClientRect();
            const newX = e.clientX - rect.left - dragOffset.x;
            const newY = e.clientY - rect.top - dragOffset.y;

            updateNode(draggedNode, { x: newX, y: newY });
        }

        function handleMouseUp() {
            draggedNode = null;
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•°
        function showValueModal() {
            if (!selectedNode) return;

            elements.modalTitle.textContent = `æ•°å€¤è¨­å®š - ${selectedNode.name}`;
            elements.targetInput.value = selectedNode.target || '';
            elements.valueInput.value = selectedNode.value || '';
            elements.unitInput.value = selectedNode.unit || '';
            
            showValueForm();
            elements.valueModal.classList.remove('hidden');
        }

        function hideValueModal() {
            elements.valueModal.classList.add('hidden');
            calculationStep = 0;
            calculationData = { parentValue: '', childEstimate: '' };
        }

        function showValueForm() {
            elements.valueForm.classList.remove('hidden');
            elements.calculationForm.classList.add('hidden');
            elements.valueFooter.classList.remove('hidden');
        }

        function showCalculationForm() {
            elements.valueForm.classList.add('hidden');
            elements.calculationForm.classList.remove('hidden');
            elements.valueFooter.classList.add('hidden');

            const parentNode = selectedNode.parent ? kpiTree.nodes[selectedNode.parent] : null;
            const parentName = parentNode ? parentNode.name : 'å£²ä¸Š';
            
            elements.parentQuestion.textContent = `ä¸Šä½KPIã€Œ${parentName}ã€ã®ç›®æ¨™å€¤ã¯ã„ãã‚‰ã§ã™ã‹ï¼Ÿ`;
            elements.childQuestion.textContent = `éå»ã®ã€Œ${selectedNode.name}ã€ã®å¹³å‡å€¤ã¯ã„ãã‚‰ã§ã—ãŸã‹ï¼Ÿ`;
        }

        function calculateValue() {
            const parentVal = parseFloat(calculationData.parentValue);
            const childEst = parseFloat(calculationData.childEstimate);
            
            if (parentVal && childEst) {
                const calculated = Math.round(parentVal / childEst);
                updateNode(selectedNode.id, { target: calculated });
                hideValueModal();
            }
        }

        function editNodeName(node) {
            const newName = prompt('KPIåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', node.name);
            if (newName && newName !== node.name) {
                updateNode(node.id, { name: newName });
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        function setupEventListeners() {
            // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            elements.btnAddRoot.addEventListener('click', startQuestionnaire);
            elements.btnSettings.addEventListener('click', showValueModal);
            elements.closeHints.addEventListener('click', () => elements.hintPanel.classList.add('hidden'));
            elements.closeModal.addEventListener('click', hideValueModal);
            elements.btnManualAdd.addEventListener('click', () => {
                const name = prompt('KPIåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
                if (name) {
                    addChildNode(selectedNode.id, { name });
                }
            });

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
            elements.btnCalculation.addEventListener('click', showCalculationForm);
            elements.btnBack.addEventListener('click', showValueForm);
            elements.btnCancel.addEventListener('click', hideValueModal);
            elements.btnSave.addEventListener('click', () => {
                updateNode(selectedNode.id, {
                    target: parseFloat(elements.targetInput.value) || undefined,
                    value: parseFloat(elements.valueInput.value) || undefined,
                    unit: elements.unitInput.value || undefined
                });
                hideValueModal();
            });

            // è¨ˆç®—ãƒ•ã‚©ãƒ¼ãƒ ã‚¤ãƒ™ãƒ³ãƒˆ
            elements.parentValue.addEventListener('input', (e) => {
                calculationData.parentValue = e.target.value;
                updateCalculateButton();
            });
            elements.childEstimate.addEventListener('input', (e) => {
                calculationData.childEstimate = e.target.value;
                updateCalculateButton();
            });
            elements.btnCalculate.addEventListener('click', calculateValue);

            // æ•°å€¤å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚¤ãƒ™ãƒ³ãƒˆ
            elements.targetInput.addEventListener('input', (e) => {
                if (selectedNode) {
                    updateNode(selectedNode.id, { target: parseFloat(e.target.value) || undefined });
                }
            });
            elements.valueInput.addEventListener('input', (e) => {
                if (selectedNode) {
                    updateNode(selectedNode.id, { value: parseFloat(e.target.value) || undefined });
                }
            });
            elements.unitInput.addEventListener('input', (e) => {
                if (selectedNode) {
                    updateNode(selectedNode.id, { unit: e.target.value || undefined });
                }
            });

            // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆ
            elements.canvas.addEventListener('mousemove', handleMouseMove);
            elements.canvas.addEventListener('mouseup', handleMouseUp);
            elements.canvas.addEventListener('mouseleave', handleMouseUp);

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯
            elements.valueModal.addEventListener('click', (e) => {
                if (e.target === elements.valueModal) {
                    hideValueModal();
                }
            });

            // è³ªå•ãƒ•ãƒ­ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            elements.btnNextQuestion.addEventListener('click', nextQuestion);
            elements.btnPrevQuestion.addEventListener('click', prevQuestion);
            
            // è³ªå•ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ï¼ˆé–‰ã˜ãªã„ï¼‰
            elements.questionnaireModal.addEventListener('click', (e) => {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…å®¹ä»¥å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚é–‰ã˜ãªã„ï¼ˆè³ªå•å›ç­”ã‚’ä¿ƒã™ãŸã‚ï¼‰
                e.stopPropagation();
            });
        }

        function updateCalculateButton() {
            const hasValues = calculationData.parentValue && calculationData.childEstimate;
            elements.btnCalculate.disabled = !hasValues;
        }

        // åˆæœŸåŒ–
        function init() {
            setupEventListeners();
            renderTree();
        }

        // DOMContentLoadedã‚¤ãƒ™ãƒ³ãƒˆã§åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>