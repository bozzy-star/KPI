<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>インテリジェントKPIツリー作成ツール</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8fafc;
            min-height: 100vh;
        }
        
        .header {
            background-color: white;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        }
        
        .header-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 4rem;
        }
        
        .header-left {
            display: flex;
            align-items: center;
        }
        
        .title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2563eb;
            margin: 0;
        }
        
        .subtitle {
            margin-left: 1rem;
            font-size: 0.875rem;
            color: #64748b;
        }
        
        .header-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn {
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 0.75rem;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }
        
        .btn-secondary {
            border: 1px solid #e2e8f0;
            background-color: #f8fafc;
            color: #0f172a;
        }
        
        .btn-primary {
            background-color: #2563eb;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1d4ed8;
        }
        
        .btn:disabled {
            background-color: #f1f5f9;
            cursor: not-allowed;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 4rem);
        }
        
        .canvas-container {
            flex: 1;
            position: relative;
        }
        
        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        .empty-content {
            text-align: center;
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .empty-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #0f172a;
        }
        
        .empty-text {
            color: #64748b;
            margin-bottom: 1.5rem;
            font-size: 1rem;
        }
        
        .btn-add-root {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            background-color: #2563eb;
            color: white;
            transition: all 0.2s ease-in-out;
        }
        
        .btn-add-root:hover {
            background-color: #1d4ed8;
        }
        
        .canvas {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: #f9fafb;
        }
        
        .canvas-content {
            position: absolute;
            top: 0;
            left: 0;
            min-width: 1200px;
            min-height: 800px;
        }
        
        .connections {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .node {
            position: absolute;
            width: 200px;
            min-height: 80px;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            border: 2px solid #e2e8f0;
            cursor: pointer;
            z-index: 2;
            transition: all 0.2s ease;
        }
        
        .node.selected {
            border-color: #2563eb;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }
        
        .node-content {
            padding: 0.75rem;
        }
        
        .node-name {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            color: #2563eb;
        }
        
        .node-description {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }
        
        .node-values {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
        }
        
        .node-value {
            color: #10b981;
            font-weight: 500;
        }
        
        .node-target {
            color: #f59e0b;
            font-weight: 500;
        }
        
        .node-formula {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.25rem;
            font-style: italic;
        }
        
        .add-child-btn {
            position: absolute;
            bottom: -0.75rem;
            left: 50%;
            transform: translateX(-50%);
            width: 1.5rem;
            height: 1.5rem;
            background-color: #2563eb;
            color: white;
            border-radius: 50%;
            font-size: 0.75rem;
            border: none;
            cursor: pointer;
        }

        .delete-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 1rem;
            height: 1rem;
            background-color: #dc2626;
            color: white;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
        }

        .delete-btn:hover {
            opacity: 1;
            background-color: #b91c1c;
        }
        
        .hint-panel {
            width: 320px;
            border-left: 1px solid #e2e8f0;
            background-color: white;
            overflow-y: auto;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .hint-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .hint-title {
            font-weight: 600;
            font-size: 1.125rem;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .node-info {
            padding: 1rem;
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .node-info-name {
            font-weight: 500;
            color: #2563eb;
            margin-bottom: 0.25rem;
        }
        
        .node-info-desc {
            font-size: 0.875rem;
            color: #64748b;
        }
        
        .hints-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .hints-subtitle {
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            margin-bottom: 0.75rem;
        }
        
        .hint-item {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            background-color: white;
        }
        
        .hint-item.selected {
            background-color: #f8fafc;
        }
        
        .hint-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .hint-name {
            font-weight: 500;
            color: #2563eb;
        }
        
        .hint-category {
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            background-color: #2563eb;
            color: white;
            border-radius: 0.25rem;
        }
        
        .hint-description {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }
        
        .hint-formula {
            font-size: 0.75rem;
            color: #2563eb;
            font-family: monospace;
            background-color: #f8fafc;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        
        .hint-details {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e2e8f0;
        }
        
        .hint-examples-title {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .hint-examples {
            font-size: 0.875rem;
            color: #64748b;
            padding-left: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .hint-examples li {
            margin-bottom: 0.25rem;
        }
        
        .btn-add-hint {
            width: 100%;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 0.75rem;
            border: none;
            cursor: pointer;
            background-color: #2563eb;
            color: white;
        }
        
        .no-hints {
            text-align: center;
            color: #64748b;
            padding: 1rem;
        }
        
        .no-hints-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }
        
        .no-hints-text {
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
        }
        
        .btn-manual-add {
            margin-top: 0.75rem;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 0.75rem;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            background-color: #f8fafc;
            color: #0f172a;
        }
        
        .hint-footer {
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            background-color: #f8fafc;
        }
        
        .hint-tip {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            max-width: 28rem;
            width: 100%;
            margin: 1rem;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin: 0;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        
        .calculation-assistant {
            background-color: #f8fafc;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        .calculation-title {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .calculation-description {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.75rem;
        }
        
        .calculation-screen {
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .calculation-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .calculation-step-title {
            font-weight: 500;
        }
        
        .calculation-step-desc {
            font-size: 0.875rem;
            color: #64748b;
        }
        
        .calculation-example {
            background-color: #dbeafe;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .calculation-example-text {
            font-size: 0.875rem;
        }
        
        .modal-footer {
            display: flex;
            gap: 0.75rem;
            padding: 1.5rem;
            border-top: 1px solid #e2e8f0;
        }
        
        .btn-flex {
            flex: 1;
        }
        
        .btn-cancel {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            background-color: #f8fafc;
            color: #0f172a;
        }
        
        .btn-save {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            background-color: #2563eb;
            color: white;
        }
        
        .btn-back {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            background-color: #f8fafc;
            color: #0f172a;
        }
        
        .btn-calculate {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            background-color: #2563eb;
            color: white;
        }
        
        .btn-calculate:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        
        .hidden {
            display: none;
        }

        /* 質問モーダルスタイル */
        .questionnaire-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .questionnaire-content {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            max-width: 32rem;
            width: 100%;
            margin: 1rem;
            max-height: 90vh;
            overflow-y: auto;
        }

        .questionnaire-header {
            padding: 2rem 2rem 1rem 2rem;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
        }

        .questionnaire-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .questionnaire-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #0f172a;
        }

        .questionnaire-subtitle {
            color: #64748b;
            font-size: 0.875rem;
        }

        .questionnaire-body {
            padding: 2rem;
        }

        .question-container {
            margin-bottom: 2rem;
        }

        .question-number {
            font-size: 0.875rem;
            color: #2563eb;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .question-text {
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 1rem;
            color: #0f172a;
        }

        .answer-options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .answer-option {
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: white;
        }

        .answer-option:hover {
            border-color: #2563eb;
            background-color: #f8fafc;
        }

        .answer-option.selected {
            border-color: #2563eb;
            background-color: #dbeafe;
        }

        .answer-title {
            font-weight: 500;
            color: #0f172a;
            margin-bottom: 0.25rem;
        }

        .answer-description {
            font-size: 0.875rem;
            color: #64748b;
        }

        .form-input-large {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .form-input-large:focus {
            outline: none;
            border-color: #2563eb;
        }

        .questionnaire-navigation {
            display: flex;
            justify-content: space-between;
            padding: 1.5rem 2rem;
            border-top: 1px solid #e2e8f0;
        }

        .btn-nav {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-nav-back {
            border: 1px solid #e2e8f0;
            background-color: white;
            color: #0f172a;
        }

        .btn-nav-back:hover {
            background-color: #f8fafc;
        }

        .btn-nav-next {
            border: none;
            background-color: #2563eb;
            color: white;
        }

        .btn-nav-next:hover {
            background-color: #1d4ed8;
        }

        .btn-nav-next:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        .progress-bar {
            height: 4px;
            background-color: #e2e8f0;
            margin-bottom: 2rem;
        }

        .progress-fill {
            height: 100%;
            background-color: #2563eb;
            transition: width 0.3s ease;
        }

        .generating-screen {
            text-align: center;
            padding: 3rem 2rem;
        }

        .generating-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .generating-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #0f172a;
        }

        .generating-subtitle {
            color: #64748b;
            margin-bottom: 2rem;
        }

        .generating-steps {
            text-align: left;
            max-width: 24rem;
            margin: 0 auto;
        }

        .generating-step {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: #f8fafc;
        }

        .generating-step.active {
            background-color: #dbeafe;
            border: 1px solid #2563eb;
        }

        .generating-step.completed {
            background-color: #dcfce7;
            border: 1px solid #16a34a;
        }

        .step-icon {
            margin-right: 0.75rem;
            font-size: 1.25rem;
        }

        .step-text {
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="header-left">
                <h1 class="title">インテリジェントKPIツリー</h1>
                <span class="subtitle" id="tree-name"></span>
            </div>
            <div class="header-buttons">
                <button class="btn btn-secondary" id="btn-settings" disabled>数値設定</button>
                <button class="btn btn-secondary" id="btn-ai-settings">AI設定</button>
                <button class="btn btn-primary">レポート生成</button>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- メインキャンバス -->
        <div class="canvas-container">
            <div id="empty-state" class="empty-state">
                <div class="empty-content">
                    <div class="empty-icon">🌳</div>
                    <h2 class="empty-title">KPIツリーを作成しましょう</h2>
                    <p class="empty-text">いくつかの質問に回答して、KPIツリーを作成しましょう</p>
                    <button class="btn-add-root" id="btn-add-root">KPIツリーを作る</button>
                </div>
            </div>
            <div id="canvas" class="canvas hidden">
                <div class="canvas-content">
                    <svg class="connections" id="connections"></svg>
                    <div id="nodes-container"></div>
                </div>
            </div>
        </div>

        <!-- ヒントパネル -->
        <div id="hint-panel" class="hint-panel hidden">
            <div class="hint-header">
                <h3 class="hint-title">KPIヒント</h3>
                <button class="close-btn" id="close-hints">✕</button>
            </div>
            <div class="node-info">
                <div class="node-info-name" id="selected-node-name"></div>
                <div class="node-info-desc" id="selected-node-desc"></div>
            </div>
            <div class="hints-content">
                <div class="hints-subtitle" id="hints-subtitle"></div>
                <div id="hints-list"></div>
                <div id="no-hints" class="no-hints hidden">
                    <div class="no-hints-icon">💡</div>
                    <div class="no-hints-text">
                        このKPIのヒントは現在準備中です。<br/>
                        手動で子KPIを追加することができます。
                    </div>
                    <button class="btn-manual-add" id="btn-manual-add">手動でKPIを追加</button>
                </div>
            </div>
            <div class="hint-footer">
                <div class="hint-tip">💡 ヒント: KPIをダブルクリックして名前を編集できます</div>
            </div>
        </div>
    </div>

    <!-- 質問モーダル -->
    <div id="questionnaire-modal" class="questionnaire-modal hidden">
        <div class="questionnaire-content">
            <div class="questionnaire-header">
                <div class="questionnaire-icon">🎯</div>
                <h2 class="questionnaire-title">KPIツリー作成アシスタント</h2>
                <p class="questionnaire-subtitle">いくつかの質問にお答えいただき、最適なKPIツリーを自動生成します</p>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>

            <div id="questionnaire-content">
                <!-- 質問コンテンツがここに動的に挿入されます -->
            </div>

            <div class="questionnaire-navigation">
                <button class="btn-nav btn-nav-back" id="btn-prev-question" style="visibility: hidden;">戻る</button>
                <button class="btn-nav btn-nav-next" id="btn-next-question" disabled>次へ</button>
            </div>
        </div>
    </div>

    <!-- 生成中画面 -->
    <div id="generating-modal" class="questionnaire-modal hidden">
        <div class="questionnaire-content">
            <div class="generating-screen">
                <div class="generating-icon">⚙️</div>
                <h2 class="generating-title">KPIツリーを生成中...</h2>
                <p class="generating-subtitle">回答内容を分析し、最適なKPIツリーを作成しています</p>
                
                <div class="generating-steps">
                    <div class="generating-step completed" id="step-analyze">
                        <div class="step-icon">✅</div>
                        <div class="step-text">回答内容を分析</div>
                    </div>
                    <div class="generating-step active" id="step-generate">
                        <div class="step-icon">⚙️</div>
                        <div class="step-text">KPIツリーを生成</div>
                    </div>
                    <div class="generating-step" id="step-complete">
                        <div class="step-icon">🌳</div>
                        <div class="step-text">ツリーを表示</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI設定モーダル -->
    <div id="ai-settings-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">AI設定</h3>
                <button class="close-btn" id="close-ai-modal">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">OpenAI APIキー</label>
                    <input type="password" class="form-input" id="openai-api-key" 
                           placeholder="sk-..." 
                           value="">
                    <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem;">
                        ※ APIキーはブラウザにのみ保存され、外部に送信されません
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">AI機能の有効化</label>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="ai-enabled" style="width: auto;">
                        <span style="font-size: 0.875rem;">AIによる動的KPIヒント生成を有効にする</span>
                    </div>
                </div>

                <div class="calculation-assistant">
                    <div class="calculation-title">🔧 設定手順</div>
                    <div class="calculation-description" style="text-align: left;">
                        <ol style="padding-left: 1.5rem; font-size: 0.875rem; line-height: 1.6;">
                            <li><a href="https://platform.openai.com/api-keys" target="_blank" style="color: #2563eb;">OpenAI Platform</a>でAPIキーを生成</li>
                            <li>Billing設定で使用上限を設定（推奨: $5-10/月）</li>
                            <li>上記にAPIキーを入力して保存</li>
                        </ol>
                    </div>
                </div>

                <div style="background-color: #f0f9ff; border: 1px solid #0284c7; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem;">
                    <div style="font-size: 0.875rem; font-weight: 500; color: #0c4a6e; margin-bottom: 0.5rem;">💰 料金目安</div>
                    <div style="font-size: 0.875rem; color: #0c4a6e;">
                        • KPIヒント生成 1回: 約$0.002-0.005<br>
                        • 月100回使用: 約$0.20-0.50<br>
                        • 安全のため月額上限設定を推奨
                    </div>
                </div>

                <div id="ai-status" style="margin-top: 1rem; padding: 0.75rem; border-radius: 0.5rem; font-size: 0.875rem;">
                    <span id="ai-status-text">APIキーが設定されていません</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel btn-flex" id="btn-ai-cancel">キャンセル</button>
                <button class="btn-save btn-flex" id="btn-ai-save">保存</button>
            </div>
        </div>
    </div>

    <!-- 数値入力ダイアログ -->
    <div id="value-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">数値設定</h3>
                <button class="close-btn" id="close-modal">✕</button>
            </div>
            <div id="value-form" class="modal-body">
                <div class="form-group">
                    <label class="form-label">目標値</label>
                    <input type="number" class="form-input" id="target-input" placeholder="目標値を入力">
                </div>
                <div class="form-group">
                    <label class="form-label">実績値</label>
                    <input type="number" class="form-input" id="value-input" placeholder="現在の実績値を入力">
                </div>
                <div class="form-group">
                    <label class="form-label">単位</label>
                    <input type="text" class="form-input" id="unit-input" placeholder="例: 円、件、人">
                </div>
                <div class="calculation-assistant">
                    <div class="calculation-title">🤖 インテリジェント計算</div>
                    <div class="calculation-description">上位KPIの情報から自動的に目標値を算出します</div>
                    <button class="btn btn-secondary" id="btn-calculation">計算アシスタントを使用</button>
                </div>
            </div>
            <div id="calculation-form" class="modal-body hidden">
                <div class="calculation-screen">
                    <div class="calculation-icon">🧮</div>
                    <div class="calculation-step-title">インテリジェント計算</div>
                    <div class="calculation-step-desc">いくつかの質問にお答えください</div>
                </div>
                <div class="form-group">
                    <label class="form-label" id="parent-question">上位KPIの目標値はいくらですか？</label>
                    <input type="number" class="form-input" id="parent-value" placeholder="例: 5000万円の場合は 50000000">
                </div>
                <div class="form-group">
                    <label class="form-label" id="child-question">過去の平均値はいくらでしたか？</label>
                    <input type="number" class="form-input" id="child-estimate" placeholder="例: 平均単価50万円の場合は 500000">
                </div>
                <div class="calculation-example">
                    <div class="calculation-example-text">💡 計算例: 売上5000万円 ÷ 平均単価50万円 = 目標件数100件</div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn-back btn-flex" id="btn-back">戻る</button>
                    <button class="btn-calculate btn-flex" id="btn-calculate" disabled>計算実行</button>
                </div>
            </div>
            <div id="value-footer" class="modal-footer">
                <button class="btn-cancel btn-flex" id="btn-cancel">キャンセル</button>
                <button class="btn-save btn-flex" id="btn-save">保存</button>
            </div>
        </div>
    </div>

    <script>
        // KPIヒントデータ
        const kpiHints = {
            '売上': [
                {
                    id: 'customers',
                    name: '顧客数',
                    description: '売上を生み出す顧客の総数。新規・既存に分けて管理することが重要です。',
                    formula: '売上 = 顧客数 × 顧客単価',
                    examples: ['月間アクティブユーザー数', '契約企業数', '会員数'],
                    category: 'customer'
                },
                {
                    id: 'customer_price',
                    name: '顧客単価',
                    description: '一人の顧客が平均的に支払う金額。LTV（顧客生涯価値）の基礎となります。',
                    formula: '売上 = 顧客数 × 顧客単価',
                    examples: ['ARPU（Average Revenue Per User）', '平均注文金額', '契約単価'],
                    category: 'revenue'
                },
                {
                    id: 'contracts',
                    name: '成約数',
                    description: '実際に契約や購入に至った件数。成約率と組み合わせて分析します。',
                    formula: '売上 = 成約数 × 平均契約金額',
                    examples: ['月間成約件数', '新規契約数', 'オーダー数'],
                    category: 'revenue'
                },
                {
                    id: 'profit_margin',
                    name: '利益率',
                    description: '売上に対する利益の割合。収益性を測る重要な指標です。',
                    formula: '利益率 = (売上 - 費用) ÷ 売上',
                    examples: ['粗利益率', '営業利益率', '純利益率'],
                    category: 'profitability'
                }
            ],
            '顧客数': [
                {
                    id: 'new_customers',
                    name: '新規顧客数',
                    description: '新たに獲得した顧客の数。成長の原動力となる重要指標です。',
                    formula: '顧客数 = 新規顧客数 + 既存顧客数',
                    examples: ['月間新規登録数', '新規契約企業数', '初回購入者数'],
                    category: 'customer'
                },
                {
                    id: 'existing_customers',
                    name: '既存顧客数',
                    description: '継続利用している顧客の数。リテンション率と密接に関係します。',
                    formula: '顧客数 = 新規顧客数 + 既存顧客数',
                    examples: ['アクティブユーザー数', '継続契約数', 'リピーター数'],
                    category: 'customer'
                },
                {
                    id: 'retention_rate',
                    name: '顧客継続率',
                    description: '既存顧客が継続して利用している割合。顧客ロイヤルティの指標です。',
                    formula: '継続率 = 継続顧客数 ÷ 期初顧客数',
                    examples: ['月次継続率', '年次継続率', 'チャーン率'],
                    category: 'customer'
                }
            ],
            '成約数': [
                {
                    id: 'proposals',
                    name: '提案数',
                    description: '顧客に対して行った提案の数。商談機会の創出力を表します。',
                    formula: '成約数 = 提案数 × 提案成約率',
                    examples: ['見積提出数', 'プレゼン実施数', '商談数'],
                    category: 'marketing'
                },
                {
                    id: 'conversion_rate',
                    name: '成約率',
                    description: '提案から成約に至る割合。営業効率を測る重要な指標です。',
                    formula: '成約率 = 成約数 ÷ 提案数',
                    examples: ['商談成約率', '見積成約率', 'クロージング率'],
                    category: 'sales'
                }
            ],
            '顧客単価': [
                {
                    id: 'purchase_frequency',
                    name: '購入頻度',
                    description: '顧客が一定期間内に購入する回数。リピート性を測る指標です。',
                    formula: '顧客単価 = 平均注文金額 × 購入頻度',
                    examples: ['月間購入回数', '年間購入回数', 'リピート率'],
                    category: 'customer'
                },
                {
                    id: 'average_order_value',
                    name: '平均注文金額',
                    description: '1回の注文あたりの平均金額。客単価の基礎となる指標です。',
                    formula: '顧客単価 = 平均注文金額 × 購入頻度',
                    examples: ['AOV', '客単価', 'バスケット単価'],
                    category: 'revenue'
                }
            ],
            '新規顧客数': [
                {
                    id: 'leads',
                    name: 'リード数',
                    description: '見込み顧客の総数。マーケティング活動の成果を表します。',
                    formula: '新規顧客数 = リード数 × コンバージョン率',
                    examples: ['問い合わせ数', '資料請求数', 'セミナー参加者数'],
                    category: 'marketing'
                },
                {
                    id: 'conversion_from_leads',
                    name: 'リードコンバージョン率',
                    description: 'リードから顧客になる割合。マーケティングから営業への効率を表します。',
                    formula: '新規顧客数 = リード数 × コンバージョン率',
                    examples: ['MQL to SQL率', 'SQL to Customer率', '全体CV率'],
                    category: 'sales'
                }
            ],
            'リード数': [
                {
                    id: 'website_visitors',
                    name: 'Webサイト訪問者数',
                    description: 'Webサイトへの訪問者数。デジタルマーケティングの起点となる指標です。',
                    formula: 'リード数 = 訪問者数 × リード獲得率',
                    examples: ['ユニークビジター数', 'セッション数', 'PV数'],
                    category: 'marketing'
                },
                {
                    id: 'lead_acquisition_rate',
                    name: 'リード獲得率',
                    description: 'サイト訪問者がリードになる割合。コンテンツの魅力度を表します。',
                    formula: 'リード数 = 訪問者数 × リード獲得率',
                    examples: ['フォーム送信率', 'ダウンロード率', 'メルマガ登録率'],
                    category: 'marketing'
                }
            ],
            '提案数': [
                {
                    id: 'qualified_leads',
                    name: '有効リード数',
                    description: '営業活動に値する質の高いリード数。営業効率に直結します。',
                    formula: '提案数 = 有効リード数 × 提案率',
                    examples: ['SQL数', 'BANTリード数', 'ホットリード数'],
                    category: 'sales'
                },
                {
                    id: 'proposal_rate',
                    name: '提案率',
                    description: '有効リードから提案に至る割合。営業プロセスの効率を表します。',
                    formula: '提案数 = 有効リード数 × 提案率',
                    examples: ['商談化率', 'ニーズヒアリング率', 'デモ実施率'],
                    category: 'sales'
                }
            ],
            '利益率': [
                {
                    id: 'cost_of_sales',
                    name: '売上原価率',
                    description: '売上に対する原価の割合。商品・サービスの原価効率を表します。',
                    formula: '利益率 = 1 - (売上原価率 + 販管費率)',
                    examples: ['原材料費率', '製造費率', '仕入原価率'],
                    category: 'cost'
                },
                {
                    id: 'operating_expense_ratio',
                    name: '販管費率',
                    description: '売上に対する販売管理費の割合。運営効率を表します。',
                    formula: '利益率 = 1 - (売上原価率 + 販管費率)',
                    examples: ['人件費率', '広告費率', '一般管理費率'],
                    category: 'cost'
                }
            ],
            'Webサイト訪問者数': [
                {
                    id: 'organic_traffic',
                    name: 'オーガニック流入',
                    description: '検索エンジンからの自然流入。SEO効果を測る指標です。',
                    formula: '訪問者数 = オーガニック流入 + 有料流入 + その他流入',
                    examples: ['Google検索流入', 'Yahoo検索流入', 'SEO流入'],
                    category: 'marketing'
                },
                {
                    id: 'paid_traffic',
                    name: '有料広告流入',
                    description: '広告からの流入。広告投資の効果を表します。',
                    formula: '訪問者数 = オーガニック流入 + 有料流入 + その他流入',
                    examples: ['Google広告流入', 'Facebook広告流入', 'ディスプレイ広告流入'],
                    category: 'marketing'
                },
                {
                    id: 'referral_traffic',
                    name: '参照サイト流入',
                    description: '他サイトからの流入。外部連携やPR効果を表します。',
                    formula: '訪問者数 = オーガニック流入 + 有料流入 + その他流入',
                    examples: ['SNS流入', 'メディア掲載流入', 'パートナーサイト流入'],
                    category: 'marketing'
                }
            ]
        };

        // 質問データ
        const questionnaire = [
            {
                id: 'business_type',
                type: 'choice',
                question: 'あなたのビジネスタイプを教えてください',
                options: [
                    {
                        value: 'ecommerce',
                        title: 'Eコマース・オンライン販売',
                        description: '商品をオンラインで販売している'
                    },
                    {
                        value: 'saas',
                        title: 'SaaS・ソフトウェアサービス',
                        description: 'サブスクリプション型のソフトウェアを提供'
                    },
                    {
                        value: 'retail',
                        title: '小売・実店舗',
                        description: '実店舗で商品を販売している'
                    },
                    {
                        value: 'service',
                        title: 'サービス業・コンサルティング',
                        description: '無形のサービスを提供している'
                    },
                    {
                        value: 'manufacturing',
                        title: '製造業',
                        description: '商品を製造・生産している'
                    },
                    {
                        value: 'other',
                        title: 'その他',
                        description: '上記に当てはまらない業種'
                    }
                ]
            },
            {
                id: 'primary_goal',
                type: 'choice',
                question: '現在の主要な経営目標は何ですか？',
                options: [
                    {
                        value: 'revenue_growth',
                        title: '売上・収益の増加',
                        description: '売上を拡大したい'
                    },
                    {
                        value: 'customer_acquisition',
                        title: '新規顧客の獲得',
                        description: '顧客数を増やしたい'
                    },
                    {
                        value: 'customer_retention',
                        title: '既存顧客の維持',
                        description: '顧客の継続率を高めたい'
                    },
                    {
                        value: 'efficiency',
                        title: '業務効率の改善',
                        description: 'コストを削減し効率を上げたい'
                    },
                    {
                        value: 'market_expansion',
                        title: '市場拡大・新規事業',
                        description: '新しい市場や事業に進出したい'
                    }
                ]
            },
            {
                id: 'company_stage',
                type: 'choice',
                question: '会社の成長ステージはどれに当てはまりますか？',
                options: [
                    {
                        value: 'startup',
                        title: 'スタートアップ（創業期）',
                        description: '事業を立ち上げたばかり'
                    },
                    {
                        value: 'growth',
                        title: '成長期',
                        description: '事業が軌道に乗り拡大中'
                    },
                    {
                        value: 'mature',
                        title: '成熟期',
                        description: '安定した収益基盤がある'
                    },
                    {
                        value: 'transformation',
                        title: '変革期',
                        description: 'ビジネスモデルを変化させている'
                    }
                ]
            },
            {
                id: 'team_size',
                type: 'choice',
                question: 'チーム・組織の規模を教えてください',
                options: [
                    {
                        value: 'solo',
                        title: '個人事業・1人',
                        description: '一人で事業を運営'
                    },
                    {
                        value: 'small',
                        title: '小規模チーム（2-10人）',
                        description: '少数精鋭のチーム'
                    },
                    {
                        value: 'medium',
                        title: '中規模組織（11-50人）',
                        description: '部門が分かれ始めている'
                    },
                    {
                        value: 'large',
                        title: '大規模組織（51人以上）',
                        description: '複数部門がある組織'
                    }
                ]
            },
            {
                id: 'timeframe',
                type: 'choice',
                question: 'KPIで管理したい期間はどれですか？',
                options: [
                    {
                        value: 'monthly',
                        title: '月次管理',
                        description: '毎月の進捗を細かく管理したい'
                    },
                    {
                        value: 'quarterly',
                        title: '四半期管理',
                        description: '3ヶ月単位で管理したい'
                    },
                    {
                        value: 'annual',
                        title: '年次管理',
                        description: '年単位での目標管理をしたい'
                    }
                ]
            },
            {
                id: 'specific_focus',
                type: 'text',
                question: '特に重視したい指標や改善したい課題があれば教えてください',
                placeholder: '例：顧客単価を上げたい、離脱率を下げたい、新規チャネルを開拓したい など'
            }
        ];

        // アプリケーション状態
        let kpiTree = null;
        let selectedNode = null;
        let draggedNode = null;
        let dragOffset = { x: 0, y: 0 };
        let selectedHintId = null;
        let calculationStep = 0;
        let calculationData = { parentValue: '', childEstimate: '' };
        
        // 質問フロー関連の状態
        let currentQuestionIndex = 0;
        let questionnaireAnswers = {};
        let isQuestionnairMode = false;
        
        // AI関連の状態
        let openaiApiKey = '';
        let aiEnabled = false;

        // DOM要素の取得
        const elements = {
            emptyState: document.getElementById('empty-state'),
            canvas: document.getElementById('canvas'),
            nodesContainer: document.getElementById('nodes-container'),
            connections: document.getElementById('connections'),
            hintPanel: document.getElementById('hint-panel'),
            valueModal: document.getElementById('value-modal'),
            treeName: document.getElementById('tree-name'),
            btnAddRoot: document.getElementById('btn-add-root'),
            btnSettings: document.getElementById('btn-settings'),
            closeHints: document.getElementById('close-hints'),
            closeModal: document.getElementById('close-modal'),
            selectedNodeName: document.getElementById('selected-node-name'),
            selectedNodeDesc: document.getElementById('selected-node-desc'),
            hintsSubtitle: document.getElementById('hints-subtitle'),
            hintsList: document.getElementById('hints-list'),
            noHints: document.getElementById('no-hints'),
            btnManualAdd: document.getElementById('btn-manual-add'),
            modalTitle: document.getElementById('modal-title'),
            valueForm: document.getElementById('value-form'),
            calculationForm: document.getElementById('calculation-form'),
            valueFooter: document.getElementById('value-footer'),
            targetInput: document.getElementById('target-input'),
            valueInput: document.getElementById('value-input'),
            unitInput: document.getElementById('unit-input'),
            btnCalculation: document.getElementById('btn-calculation'),
            parentQuestion: document.getElementById('parent-question'),
            childQuestion: document.getElementById('child-question'),
            parentValue: document.getElementById('parent-value'),
            childEstimate: document.getElementById('child-estimate'),
            btnBack: document.getElementById('btn-back'),
            btnCalculate: document.getElementById('btn-calculate'),
            btnCancel: document.getElementById('btn-cancel'),
            btnSave: document.getElementById('btn-save'),
            
            // 質問モーダル関連
            questionnaireModal: document.getElementById('questionnaire-modal'),
            generatingModal: document.getElementById('generating-modal'),
            questionnaireContent: document.getElementById('questionnaire-content'),
            progressFill: document.getElementById('progress-fill'),
            btnPrevQuestion: document.getElementById('btn-prev-question'),
            btnNextQuestion: document.getElementById('btn-next-question'),
            
            // AI設定関連
            btnAiSettings: document.getElementById('btn-ai-settings'),
            aiSettingsModal: document.getElementById('ai-settings-modal'),
            closeAiModal: document.getElementById('close-ai-modal'),
            openaiApiKeyInput: document.getElementById('openai-api-key'),
            aiEnabledCheckbox: document.getElementById('ai-enabled'),
            aiStatus: document.getElementById('ai-status'),
            aiStatusText: document.getElementById('ai-status-text'),
            btnAiCancel: document.getElementById('btn-ai-cancel'),
            btnAiSave: document.getElementById('btn-ai-save')
        };

        // ユーティリティ関数
        function generateId() {
            return 'node-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        function getCategoryLabel(category) {
            const labels = { 
                customer: '顧客', 
                revenue: '売上', 
                marketing: 'マーケ', 
                sales: '営業',
                profitability: '収益性',
                cost: 'コスト'
            };
            return labels[category] || category;
        }

        // AI設定管理関数
        function loadAISettings() {
            const savedApiKey = localStorage.getItem('openai-api-key');
            const savedAiEnabled = localStorage.getItem('ai-enabled') === 'true';
            
            if (savedApiKey) {
                openaiApiKey = savedApiKey;
                elements.openaiApiKeyInput.value = savedApiKey;
            }
            
            aiEnabled = savedAiEnabled;
            elements.aiEnabledCheckbox.checked = savedAiEnabled;
            
            updateAIStatus();
        }

        function saveAISettings() {
            openaiApiKey = elements.openaiApiKeyInput.value.trim();
            aiEnabled = elements.aiEnabledCheckbox.checked;
            
            if (openaiApiKey) {
                localStorage.setItem('openai-api-key', openaiApiKey);
            } else {
                localStorage.removeItem('openai-api-key');
            }
            
            localStorage.setItem('ai-enabled', aiEnabled.toString());
            updateAIStatus();
        }

        function updateAIStatus() {
            const hasApiKey = openaiApiKey && openaiApiKey.length > 0;
            
            if (hasApiKey && aiEnabled) {
                elements.aiStatus.style.backgroundColor = '#dcfce7';
                elements.aiStatus.style.border = '1px solid #16a34a';
                elements.aiStatusText.textContent = 'AI機能が有効です';
            } else if (hasApiKey && !aiEnabled) {
                elements.aiStatus.style.backgroundColor = '#fef3c7';
                elements.aiStatus.style.border = '1px solid #d97706';
                elements.aiStatusText.textContent = 'APIキーは設定済み（機能は無効）';
            } else {
                elements.aiStatus.style.backgroundColor = '#fee2e2';
                elements.aiStatus.style.border = '1px solid #dc2626';
                elements.aiStatusText.textContent = 'APIキーが設定されていません';
            }
        }

        function showAISettings() {
            elements.aiSettingsModal.classList.remove('hidden');
        }

        function hideAISettings() {
            elements.aiSettingsModal.classList.add('hidden');
        }

        // OpenAI API呼び出し関数
        async function callOpenAI(prompt, maxTokens = 500) {
            if (!openaiApiKey || !aiEnabled) {
                throw new Error('OpenAI APIが設定されていません');
            }

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${openaiApiKey}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'あなたはビジネスKPIの専門家です。日本語で回答してください。KPIの階層構造と関係性について詳しく説明できます。'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: maxTokens,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`OpenAI API エラー: ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                return data.choices[0].message.content.trim();
            } catch (error) {
                console.error('OpenAI API call failed:', error);
                throw error;
            }
        }

        // AIを使ったKPIヒント生成
        async function generateAIHints(kpiName, context = {}) {
            if (!aiEnabled || !openaiApiKey) {
                return null; // 静的ヒントにフォールバック
            }

            try {
                const contextInfo = context.businessType ? `ビジネスタイプ: ${context.businessType}` : '';
                const prompt = `
KPI「${kpiName}」の下層KPIとして適切な指標を3-5個提案してください。${contextInfo}

以下のJSON形式で回答してください：
[
  {
    "name": "KPI名",
    "description": "KPIの説明（1-2文）",
    "formula": "計算式や関係性",
    "examples": ["具体例1", "具体例2", "具体例3"],
    "category": "customer/revenue/marketing/sales/cost/operationsのいずれか"
  }
]

ビジネスで実際に使われる実用的なKPIを提案してください。
                `;

                const response = await callOpenAI(prompt, 800);
                
                // JSONパースを試行
                try {
                    const hints = JSON.parse(response);
                    if (Array.isArray(hints)) {
                        return hints.map((hint, index) => ({
                            id: `ai-hint-${Date.now()}-${index}`,
                            ...hint
                        }));
                    }
                } catch (parseError) {
                    console.warn('AI response parsing failed, falling back to static hints');
                }
                
                return null; // パースに失敗した場合は静的ヒントにフォールバック
            } catch (error) {
                console.warn('AI hint generation failed:', error);
                return null; // エラー時は静的ヒントにフォールバック
            }
        }

        // 質問フロー関数
        function startQuestionnaire() {
            isQuestionnairMode = true;
            currentQuestionIndex = 0;
            questionnaireAnswers = {};
            
            elements.questionnaireModal.classList.remove('hidden');
            showQuestion(currentQuestionIndex);
        }

        function showQuestion(index) {
            const question = questionnaire[index];
            const progress = ((index + 1) / questionnaire.length) * 100;
            
            elements.progressFill.style.width = progress + '%';
            
            if (question.type === 'choice') {
                renderChoiceQuestion(question, index);
            } else if (question.type === 'text') {
                renderTextQuestion(question, index);
            }
            
            // ナビゲーションボタンの状態更新
            elements.btnPrevQuestion.style.visibility = index > 0 ? 'visible' : 'hidden';
            elements.btnNextQuestion.textContent = index === questionnaire.length - 1 ? 'KPIツリーを生成' : '次へ';
            updateNextButton();
        }

        function renderChoiceQuestion(question, index) {
            const options = question.options.map(option => `
                <div class="answer-option" data-value="${option.value}">
                    <div class="answer-title">${option.title}</div>
                    <div class="answer-description">${option.description}</div>
                </div>
            `).join('');

            elements.questionnaireContent.innerHTML = `
                <div class="questionnaire-body">
                    <div class="question-container">
                        <div class="question-number">質問 ${index + 1} / ${questionnaire.length}</div>
                        <div class="question-text">${question.question}</div>
                        <div class="answer-options">
                            ${options}
                        </div>
                    </div>
                </div>
            `;

            // 選択肢のイベントリスナーを追加
            const answerOptions = elements.questionnaireContent.querySelectorAll('.answer-option');
            answerOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // 他の選択肢の選択を解除
                    answerOptions.forEach(opt => opt.classList.remove('selected'));
                    // 現在の選択肢を選択
                    option.classList.add('selected');
                    // 回答を保存
                    questionnaireAnswers[question.id] = option.dataset.value;
                    updateNextButton();
                });
            });

            // 既存の回答があれば復元
            if (questionnaireAnswers[question.id]) {
                const selectedOption = elements.questionnaireContent.querySelector(`[data-value="${questionnaireAnswers[question.id]}"]`);
                if (selectedOption) {
                    selectedOption.classList.add('selected');
                }
            }
        }

        function renderTextQuestion(question, index) {
            elements.questionnaireContent.innerHTML = `
                <div class="questionnaire-body">
                    <div class="question-container">
                        <div class="question-number">質問 ${index + 1} / ${questionnaire.length}</div>
                        <div class="question-text">${question.question}</div>
                        <input type="text" class="form-input-large" id="text-answer" 
                               placeholder="${question.placeholder || ''}" 
                               value="${questionnaireAnswers[question.id] || ''}">
                    </div>
                </div>
            `;

            const textInput = document.getElementById('text-answer');
            textInput.addEventListener('input', () => {
                questionnaireAnswers[question.id] = textInput.value;
                updateNextButton();
            });
        }

        function updateNextButton() {
            const currentQuestion = questionnaire[currentQuestionIndex];
            const hasAnswer = questionnaireAnswers[currentQuestion.id];
            
            if (currentQuestion.type === 'choice') {
                elements.btnNextQuestion.disabled = !hasAnswer;
            } else if (currentQuestion.type === 'text') {
                // テキスト質問は任意回答なので常に有効
                elements.btnNextQuestion.disabled = false;
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < questionnaire.length - 1) {
                currentQuestionIndex++;
                showQuestion(currentQuestionIndex);
            } else {
                // 最後の質問の場合、KPIツリーを生成
                generateKPITree();
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion(currentQuestionIndex);
            }
        }

        function generateKPITree() {
            // 質問モーダルを隠して生成中画面を表示
            elements.questionnaireModal.classList.add('hidden');
            elements.generatingModal.classList.remove('hidden');

            // 生成ステップのアニメーション
            setTimeout(() => {
                document.getElementById('step-generate').classList.remove('active');
                document.getElementById('step-generate').classList.add('completed');
                document.getElementById('step-complete').classList.add('active');
                
                setTimeout(() => {
                    document.getElementById('step-complete').classList.remove('active');
                    document.getElementById('step-complete').classList.add('completed');
                    
                    // 実際のKPIツリー生成
                    const generatedTree = createKPITreeFromAnswers(questionnaireAnswers);
                    
                    setTimeout(() => {
                        elements.generatingModal.classList.add('hidden');
                        displayGeneratedTree(generatedTree);
                    }, 1000);
                }, 1500);
            }, 2000);
        }

        function createKPITreeFromAnswers(answers) {
            // 回答に基づいてKPIツリーを生成
            const businessType = answers.business_type;
            const primaryGoal = answers.primary_goal;
            const companyStage = answers.company_stage;
            
            // ビジネスタイプに基づく基本構造
            const treeTemplates = {
                ecommerce: {
                    root: { name: '売上', description: 'Eコマースの総売上' },
                    level1: [
                        { name: '顧客数', description: '購入顧客の総数' },
                        { name: '顧客単価', description: '顧客あたりの平均購入金額' }
                    ]
                },
                saas: {
                    root: { name: 'ARR', description: '年間経常収益' },
                    level1: [
                        { name: '新規顧客数', description: '新規獲得顧客数' },
                        { name: 'ARPU', description: '顧客あたり平均収益' },
                        { name: '継続率', description: '顧客継続率' }
                    ]
                },
                retail: {
                    root: { name: '売上', description: '店舗総売上' },
                    level1: [
                        { name: '来店客数', description: '店舗への来客数' },
                        { name: '客単価', description: '1回あたりの購入金額' }
                    ]
                },
                service: {
                    root: { name: '売上', description: 'サービス売上' },
                    level1: [
                        { name: 'クライアント数', description: '契約クライアント数' },
                        { name: 'プロジェクト単価', description: '1プロジェクトあたりの単価' }
                    ]
                },
                manufacturing: {
                    root: { name: '売上', description: '製品売上' },
                    level1: [
                        { name: '生産量', description: '製品生産数' },
                        { name: '製品単価', description: '製品あたりの平均単価' }
                    ]
                },
                other: {
                    root: { name: '売上', description: 'ビジネス売上' },
                    level1: [
                        { name: '顧客数', description: '顧客の総数' },
                        { name: '顧客単価', description: '顧客あたりの平均単価' }
                    ]
                }
            };

            const template = treeTemplates[businessType] || treeTemplates.other;
            
            // 主要目標に基づく調整
            if (primaryGoal === 'customer_acquisition') {
                template.level1.unshift({ name: 'リード数', description: '見込み顧客数' });
            } else if (primaryGoal === 'efficiency') {
                template.level1.push({ name: '利益率', description: '売上利益率' });
            }

            return template;
        }

        function displayGeneratedTree(treeTemplate) {
            // 生成されたテンプレートからKPIツリーを構築
            const rootNode = {
                id: 'root',
                name: treeTemplate.root.name,
                level: 0,
                x: 400,
                y: 100,
                children: [],
                description: treeTemplate.root.description
            };

            const nodes = { root: rootNode };

            // レベル1のノードを追加
            treeTemplate.level1.forEach((kpi, index) => {
                const childId = `node-level1-${index}`;
                const childNode = {
                    id: childId,
                    name: kpi.name,
                    level: 1,
                    x: 200 + (index * 250),
                    y: 250,
                    children: [],
                    parent: 'root',
                    description: kpi.description
                };
                
                nodes[childId] = childNode;
                rootNode.children.push(childId);
            });

            kpiTree = {
                id: 'generated-tree',
                name: 'AI生成KPIツリー',
                nodes: nodes,
                rootNodeId: 'root'
            };

            selectedNode = rootNode;
            isQuestionnairMode = false;
            
            renderTree();
            showHints();
            
            elements.treeName.textContent = kpiTree.name;
            elements.btnSettings.disabled = false;
        }

        // KPIツリー操作関数
        function addRootNode() {
            const rootNode = {
                id: 'root',
                name: '売上',
                level: 0,
                x: 400,
                y: 100,
                children: [],
                description: 'ビジネスの主要目標指標'
            };

            kpiTree = {
                id: 'tree-1',
                name: '新規KPIツリー',
                nodes: { root: rootNode },
                rootNodeId: 'root'
            };

            selectedNode = rootNode;
            renderTree();
            showHints();
            
            elements.treeName.textContent = kpiTree.name;
            elements.btnSettings.disabled = false;
        }

        function addChildNode(parentId, childData) {
            if (!kpiTree) return;

            const childId = generateId();
            const parentNode = kpiTree.nodes[parentId];
            
            const childNode = {
                id: childId,
                name: childData.name || '新しいKPI',
                level: parentNode.level + 1,
                x: parentNode.x + (parentNode.children.length * 200) - 100,
                y: parentNode.y + 150,
                children: [],
                parent: parentId,
                description: childData.description,
                formula: childData.formula
            };

            parentNode.children.push(childId);
            kpiTree.nodes[childId] = childNode;

            selectedNode = childNode;
            renderTree();
            showHints();
        }

        function updateNode(nodeId, updates) {
            if (!kpiTree || !kpiTree.nodes[nodeId]) return;
            
            Object.assign(kpiTree.nodes[nodeId], updates);
            renderTree();
        }

        function deleteNode(nodeId) {
            if (!kpiTree || !kpiTree.nodes[nodeId] || nodeId === 'root') return;
            
            const node = kpiTree.nodes[nodeId];
            
            // 子ノードを再帰的に削除
            if (node.children && node.children.length > 0) {
                [...node.children].forEach(childId => deleteNode(childId));
            }
            
            // 親ノードから自分を削除
            if (node.parent && kpiTree.nodes[node.parent]) {
                const parentNode = kpiTree.nodes[node.parent];
                parentNode.children = parentNode.children.filter(childId => childId !== nodeId);
            }
            
            // ノードを削除
            delete kpiTree.nodes[nodeId];
            
            // 選択されていたノードが削除された場合
            if (selectedNode && selectedNode.id === nodeId) {
                selectedNode = null;
                elements.hintPanel.classList.add('hidden');
                elements.btnSettings.disabled = true;
            }
            
            renderTree();
        }

        function selectNode(node) {
            selectedNode = node;
            renderTree();
            showHints();
        }

        // レンダリング関数
        function renderTree() {
            if (!kpiTree || Object.keys(kpiTree.nodes).length === 0) {
                elements.emptyState.classList.remove('hidden');
                elements.canvas.classList.add('hidden');
                elements.hintPanel.classList.add('hidden');
                return;
            }

            elements.emptyState.classList.add('hidden');
            elements.canvas.classList.remove('hidden');

            renderConnections();
            renderNodes();
        }

        function renderConnections() {
            const svg = elements.connections;
            svg.innerHTML = '';

            Object.values(kpiTree.nodes).forEach(parent => {
                parent.children.forEach(childId => {
                    const child = kpiTree.nodes[childId];
                    if (!child) return;

                    const parentCenterX = parent.x + 100;
                    const parentCenterY = parent.y + 40;
                    const childCenterX = child.x + 100;
                    const childCenterY = child.y + 40;

                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', parentCenterX);
                    line.setAttribute('y1', parentCenterY);
                    line.setAttribute('x2', childCenterX);
                    line.setAttribute('y2', childCenterY);
                    line.setAttribute('stroke', '#e2e8f0');
                    line.setAttribute('stroke-width', '2');

                    const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                    arrow.setAttribute('points', `${childCenterX-5},${childCenterY-5} ${childCenterX+5},${childCenterY-5} ${childCenterX},${childCenterY+5}`);
                    arrow.setAttribute('fill', '#e2e8f0');

                    svg.appendChild(line);
                    svg.appendChild(arrow);
                });
            });
        }

        function renderNodes() {
            const container = elements.nodesContainer;
            container.innerHTML = '';

            Object.values(kpiTree.nodes).forEach(node => {
                const nodeElement = createNodeElement(node);
                container.appendChild(nodeElement);
            });
        }

        function createNodeElement(node) {
            const isSelected = selectedNode?.id === node.id;
            
            const nodeDiv = document.createElement('div');
            nodeDiv.className = `node ${isSelected ? 'selected' : ''}`;
            nodeDiv.style.left = node.x + 'px';
            nodeDiv.style.top = node.y + 'px';

            const values = [];
            if (node.value) values.push(`<div class="node-value">実績: ${node.value}${node.unit || ''}</div>`);
            if (node.target) values.push(`<div class="node-target">目標: ${node.target}${node.unit || ''}</div>`);

            nodeDiv.innerHTML = `
                <div class="node-content">
                    <div class="node-name">${node.name}</div>
                    ${node.description ? `<div class="node-description">${node.description}</div>` : ''}
                    ${values.length > 0 ? `<div class="node-values">${values.join('')}</div>` : ''}
                    ${node.formula ? `<div class="node-formula">${node.formula}</div>` : ''}
                </div>
                <button class="add-child-btn" title="子KPIを追加">+</button>
                ${node.id !== 'root' ? '<button class="delete-btn" title="KPIを削除">🗑️</button>' : ''}
            `;

            // イベントリスナー
            nodeDiv.addEventListener('click', () => selectNode(node));
            nodeDiv.addEventListener('dblclick', () => editNodeName(node));
            nodeDiv.addEventListener('mousedown', (e) => startDrag(e, node.id));

            const addBtn = nodeDiv.querySelector('.add-child-btn');
            addBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const name = prompt('KPI名を入力してください:');
                if (name) {
                    addChildNode(node.id, { name });
                }
            });

            const deleteBtn = nodeDiv.querySelector('.delete-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`「${node.name}」とその子KPIを削除しますか？`)) {
                        deleteNode(node.id);
                    }
                });
            }

            return nodeDiv;
        }

        // ヒントパネル関数
        async function showHints() {
            if (!selectedNode) {
                elements.hintPanel.classList.add('hidden');
                return;
            }

            elements.hintPanel.classList.remove('hidden');
            elements.selectedNodeName.textContent = selectedNode.name;
            elements.selectedNodeDesc.textContent = selectedNode.description || '';
            elements.hintsSubtitle.textContent = `「${selectedNode.name}」の下位KPI候補:`;

            // 静的ヒント
            const staticHints = kpiHints[selectedNode.name] || [];
            
            // AIヒントを試行（設定されている場合）
            let aiHints = null;
            if (aiEnabled && openaiApiKey) {
                try {
                    elements.hintsSubtitle.textContent = `「${selectedNode.name}」の下位KPI候補: 🤖 AI分析中...`;
                    
                    const context = questionnaireAnswers ? {
                        businessType: questionnaireAnswers.business_type
                    } : {};
                    
                    aiHints = await generateAIHints(selectedNode.name, context);
                } catch (error) {
                    console.warn('AI hint generation failed, using static hints:', error);
                }
            }

            // AIヒントが取得できた場合はそれを使用、そうでなければ静的ヒント
            const hints = aiHints || staticHints;
            elements.hintsSubtitle.textContent = `「${selectedNode.name}」の下位KPI候補:${aiHints ? ' 🤖 AI生成' : ''}`;
            
            renderHints(hints);
        }

        function renderHints(hints) {
            const container = elements.hintsList;
            container.innerHTML = '';

            if (hints.length === 0) {
                elements.noHints.classList.remove('hidden');
                return;
            }

            elements.noHints.classList.add('hidden');

            hints.forEach(hint => {
                const hintElement = createHintElement(hint);
                container.appendChild(hintElement);
            });
        }

        function createHintElement(hint) {
            const isSelected = selectedHintId === hint.id;
            
            const hintDiv = document.createElement('div');
            hintDiv.className = `hint-item ${isSelected ? 'selected' : ''}`;

            const examples = hint.examples.map(ex => `<li>${ex}</li>`).join('');

            hintDiv.innerHTML = `
                <div class="hint-header-row">
                    <div class="hint-name">${hint.name}</div>
                    <div class="hint-category">${getCategoryLabel(hint.category)}</div>
                </div>
                <div class="hint-description">${hint.description}</div>
                <div class="hint-formula">${hint.formula}</div>
                ${isSelected ? `
                    <div class="hint-details">
                        <div class="hint-examples-title">具体例:</div>
                        <ul class="hint-examples">${examples}</ul>
                        <button class="btn-add-hint">このKPIを追加</button>
                    </div>
                ` : ''}
            `;

            hintDiv.addEventListener('click', () => {
                selectedHintId = selectedHintId === hint.id ? null : hint.id;
                renderHints(kpiHints[selectedNode.name] || []);
            });

            if (isSelected) {
                const addBtn = hintDiv.querySelector('.btn-add-hint');
                addBtn.addEventListener('click', () => {
                    addChildNode(selectedNode.id, hint);
                    selectedHintId = null;
                });
            }

            return hintDiv;
        }

        // ドラッグ機能
        function startDrag(e, nodeId) {
            draggedNode = nodeId;
            const rect = e.currentTarget.getBoundingClientRect();
            dragOffset = {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        function handleMouseMove(e) {
            if (!draggedNode) return;
            
            const rect = elements.canvas.getBoundingClientRect();
            const newX = e.clientX - rect.left - dragOffset.x;
            const newY = e.clientY - rect.top - dragOffset.y;

            updateNode(draggedNode, { x: newX, y: newY });
        }

        function handleMouseUp() {
            draggedNode = null;
        }

        // モーダル関数
        function showValueModal() {
            if (!selectedNode) return;

            elements.modalTitle.textContent = `数値設定 - ${selectedNode.name}`;
            elements.targetInput.value = selectedNode.target || '';
            elements.valueInput.value = selectedNode.value || '';
            elements.unitInput.value = selectedNode.unit || '';
            
            showValueForm();
            elements.valueModal.classList.remove('hidden');
        }

        function hideValueModal() {
            elements.valueModal.classList.add('hidden');
            calculationStep = 0;
            calculationData = { parentValue: '', childEstimate: '' };
        }

        function showValueForm() {
            elements.valueForm.classList.remove('hidden');
            elements.calculationForm.classList.add('hidden');
            elements.valueFooter.classList.remove('hidden');
        }

        function showCalculationForm() {
            elements.valueForm.classList.add('hidden');
            elements.calculationForm.classList.remove('hidden');
            elements.valueFooter.classList.add('hidden');

            const parentNode = selectedNode.parent ? kpiTree.nodes[selectedNode.parent] : null;
            const parentName = parentNode ? parentNode.name : '売上';
            
            elements.parentQuestion.textContent = `上位KPI「${parentName}」の目標値はいくらですか？`;
            elements.childQuestion.textContent = `過去の「${selectedNode.name}」の平均値はいくらでしたか？`;
        }

        function calculateValue() {
            const parentVal = parseFloat(calculationData.parentValue);
            const childEst = parseFloat(calculationData.childEstimate);
            
            if (parentVal && childEst) {
                const calculated = Math.round(parentVal / childEst);
                updateNode(selectedNode.id, { target: calculated });
                hideValueModal();
            }
        }

        function editNodeName(node) {
            const newName = prompt('KPI名を入力してください:', node.name);
            if (newName && newName !== node.name) {
                updateNode(node.id, { name: newName });
            }
        }

        // イベントリスナーの設定
        function setupEventListeners() {
            // ボタンイベント
            elements.btnAddRoot.addEventListener('click', startQuestionnaire);
            elements.btnSettings.addEventListener('click', showValueModal);
            elements.btnAiSettings.addEventListener('click', showAISettings);
            elements.closeHints.addEventListener('click', () => elements.hintPanel.classList.add('hidden'));
            elements.closeModal.addEventListener('click', hideValueModal);
            elements.btnManualAdd.addEventListener('click', () => {
                const name = prompt('KPI名を入力してください:');
                if (name) {
                    addChildNode(selectedNode.id, { name });
                }
            });

            // モーダルイベント
            elements.btnCalculation.addEventListener('click', showCalculationForm);
            elements.btnBack.addEventListener('click', showValueForm);
            elements.btnCancel.addEventListener('click', hideValueModal);
            elements.btnSave.addEventListener('click', () => {
                updateNode(selectedNode.id, {
                    target: parseFloat(elements.targetInput.value) || undefined,
                    value: parseFloat(elements.valueInput.value) || undefined,
                    unit: elements.unitInput.value || undefined
                });
                hideValueModal();
            });

            // 計算フォームイベント
            elements.parentValue.addEventListener('input', (e) => {
                calculationData.parentValue = e.target.value;
                updateCalculateButton();
            });
            elements.childEstimate.addEventListener('input', (e) => {
                calculationData.childEstimate = e.target.value;
                updateCalculateButton();
            });
            elements.btnCalculate.addEventListener('click', calculateValue);

            // 数値入力フォームイベント
            elements.targetInput.addEventListener('input', (e) => {
                if (selectedNode) {
                    updateNode(selectedNode.id, { target: parseFloat(e.target.value) || undefined });
                }
            });
            elements.valueInput.addEventListener('input', (e) => {
                if (selectedNode) {
                    updateNode(selectedNode.id, { value: parseFloat(e.target.value) || undefined });
                }
            });
            elements.unitInput.addEventListener('input', (e) => {
                if (selectedNode) {
                    updateNode(selectedNode.id, { unit: e.target.value || undefined });
                }
            });

            // ドラッグイベント
            elements.canvas.addEventListener('mousemove', handleMouseMove);
            elements.canvas.addEventListener('mouseup', handleMouseUp);
            elements.canvas.addEventListener('mouseleave', handleMouseUp);

            // モーダルオーバーレイクリック
            elements.valueModal.addEventListener('click', (e) => {
                if (e.target === elements.valueModal) {
                    hideValueModal();
                }
            });

            // 質問フローのイベントリスナー
            elements.btnNextQuestion.addEventListener('click', nextQuestion);
            elements.btnPrevQuestion.addEventListener('click', prevQuestion);
            
            // 質問モーダルのオーバーレイクリック（閉じない）
            elements.questionnaireModal.addEventListener('click', (e) => {
                // モーダル内容以外をクリックしても閉じない（質問回答を促すため）
                e.stopPropagation();
            });

            // AI設定のイベントリスナー
            elements.closeAiModal.addEventListener('click', hideAISettings);
            elements.btnAiCancel.addEventListener('click', hideAISettings);
            elements.btnAiSave.addEventListener('click', () => {
                saveAISettings();
                hideAISettings();
            });

            // AI設定モーダルのオーバーレイクリック
            elements.aiSettingsModal.addEventListener('click', (e) => {
                if (e.target === elements.aiSettingsModal) {
                    hideAISettings();
                }
            });
        }

        function updateCalculateButton() {
            const hasValues = calculationData.parentValue && calculationData.childEstimate;
            elements.btnCalculate.disabled = !hasValues;
        }

        // 初期化
        function init() {
            setupEventListeners();
            loadAISettings();
            renderTree();
        }

        // DOMContentLoadedイベントで初期化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>