<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç§„É≥„ÉÜ„É™„Ç∏„Çß„É≥„ÉàKPI„ÉÑ„É™„Éº‰ΩúÊàê„ÉÑ„Éº„É´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8fafc;
            min-height: 100vh;
        }
        
        .header {
            background-color: white;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        }
        
        .header-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 4rem;
        }
        
        .header-left {
            display: flex;
            align-items: center;
        }
        
        .title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2563eb;
            margin: 0;
        }
        
        .subtitle {
            margin-left: 1rem;
            font-size: 0.875rem;
            color: #64748b;
        }
        
        .header-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn {
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 0.75rem;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }
        
        .btn-secondary {
            border: 1px solid #e2e8f0;
            background-color: #f8fafc;
            color: #0f172a;
        }
        
        .btn-primary {
            background-color: #2563eb;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1d4ed8;
        }
        
        .btn:disabled {
            background-color: #f1f5f9;
            cursor: not-allowed;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 4rem);
        }
        
        .canvas-container {
            flex: 1;
            position: relative;
        }
        
        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        .empty-content {
            text-align: center;
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .empty-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #0f172a;
        }
        
        .empty-text {
            color: #64748b;
            margin-bottom: 1.5rem;
            font-size: 1rem;
        }
        
        .btn-add-root {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            background-color: #2563eb;
            color: white;
            transition: all 0.2s ease-in-out;
        }
        
        .btn-add-root:hover {
            background-color: #1d4ed8;
        }
        
        .canvas {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: #f9fafb;
        }
        
        .canvas-content {
            position: absolute;
            top: 0;
            left: 0;
            min-width: 1200px;
            min-height: 800px;
        }
        
        .connections {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .node {
            position: absolute;
            width: 200px;
            min-height: 80px;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            border: 2px solid #e2e8f0;
            cursor: pointer;
            z-index: 2;
            transition: all 0.2s ease;
        }
        
        .node.selected {
            border-color: #2563eb;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }
        
        .node-content {
            padding: 0.75rem;
        }
        
        .node-name {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            color: #2563eb;
        }
        
        .node-description {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }
        
        .node-values {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
        }
        
        .node-value {
            color: #10b981;
            font-weight: 500;
        }
        
        .node-target {
            color: #f59e0b;
            font-weight: 500;
        }
        
        .node-formula {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.25rem;
            font-style: italic;
        }
        
        .add-child-btn {
            position: absolute;
            bottom: -0.75rem;
            left: 50%;
            transform: translateX(-50%);
            width: 1.5rem;
            height: 1.5rem;
            background-color: #2563eb;
            color: white;
            border-radius: 50%;
            font-size: 0.75rem;
            border: none;
            cursor: pointer;
        }

        .delete-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 1rem;
            height: 1rem;
            background-color: #dc2626;
            color: white;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
        }

        .delete-btn:hover {
            opacity: 1;
            background-color: #b91c1c;
        }
        
        .hint-panel {
            width: 320px;
            border-left: 1px solid #e2e8f0;
            background-color: white;
            overflow-y: auto;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .hint-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .hint-title {
            font-weight: 600;
            font-size: 1.125rem;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .node-info {
            padding: 1rem;
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .node-info-name {
            font-weight: 500;
            color: #2563eb;
            margin-bottom: 0.25rem;
        }
        
        .node-info-desc {
            font-size: 0.875rem;
            color: #64748b;
        }
        
        .hints-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .hints-subtitle {
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            margin-bottom: 0.75rem;
        }
        
        .hint-item {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            background-color: white;
        }
        
        .hint-item.selected {
            background-color: #f8fafc;
        }
        
        .hint-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .hint-name {
            font-weight: 500;
            color: #2563eb;
        }
        
        .hint-category {
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            background-color: #2563eb;
            color: white;
            border-radius: 0.25rem;
        }
        
        .hint-description {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }
        
        .hint-formula {
            font-size: 0.75rem;
            color: #2563eb;
            font-family: monospace;
            background-color: #f8fafc;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        
        .hint-details {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e2e8f0;
        }
        
        .hint-examples-title {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .hint-examples {
            font-size: 0.875rem;
            color: #64748b;
            padding-left: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .hint-examples li {
            margin-bottom: 0.25rem;
        }
        
        .btn-add-hint {
            width: 100%;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 0.75rem;
            border: none;
            cursor: pointer;
            background-color: #2563eb;
            color: white;
        }
        
        .no-hints {
            text-align: center;
            color: #64748b;
            padding: 1rem;
        }
        
        .no-hints-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }
        
        .no-hints-text {
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
        }
        
        .btn-manual-add {
            margin-top: 0.75rem;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 0.75rem;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            background-color: #f8fafc;
            color: #0f172a;
        }
        
        .hint-footer {
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            background-color: #f8fafc;
        }
        
        .hint-tip {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            max-width: 28rem;
            width: 100%;
            margin: 1rem;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin: 0;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        
        .calculation-assistant {
            background-color: #f8fafc;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        .calculation-title {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .calculation-description {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.75rem;
        }
        
        .calculation-screen {
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .calculation-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .calculation-step-title {
            font-weight: 500;
        }
        
        .calculation-step-desc {
            font-size: 0.875rem;
            color: #64748b;
        }
        
        .calculation-example {
            background-color: #dbeafe;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .calculation-example-text {
            font-size: 0.875rem;
        }
        
        .modal-footer {
            display: flex;
            gap: 0.75rem;
            padding: 1.5rem;
            border-top: 1px solid #e2e8f0;
        }
        
        .btn-flex {
            flex: 1;
        }
        
        .btn-cancel {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            background-color: #f8fafc;
            color: #0f172a;
        }
        
        .btn-save {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            background-color: #2563eb;
            color: white;
        }
        
        .btn-back {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            background-color: #f8fafc;
            color: #0f172a;
        }
        
        .btn-calculate {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            background-color: #2563eb;
            color: white;
        }
        
        .btn-calculate:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="header-left">
                <h1 class="title">„Ç§„É≥„ÉÜ„É™„Ç∏„Çß„É≥„ÉàKPI„ÉÑ„É™„Éº</h1>
                <span class="subtitle" id="tree-name"></span>
            </div>
            <div class="header-buttons">
                <button class="btn btn-secondary" id="btn-settings" disabled>Êï∞ÂÄ§Ë®≠ÂÆö</button>
                <button class="btn btn-primary">„É¨„Éù„Éº„ÉàÁîüÊàê</button>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- „É°„Ç§„É≥„Ç≠„É£„É≥„Éê„Çπ -->
        <div class="canvas-container">
            <div id="empty-state" class="empty-state">
                <div class="empty-content">
                    <div class="empty-icon">üå≥</div>
                    <h2 class="empty-title">KPI„ÉÑ„É™„Éº„Çí‰ΩúÊàê„Åó„Åæ„Åó„Çá„ÅÜ</h2>
                    <p class="empty-text">„ÅÑ„Åè„Å§„Åã„ÅÆË≥™Âïè„Å´ÂõûÁ≠î„Åó„Å¶„ÄÅKPI„ÉÑ„É™„Éº„Çí‰ΩúÊàê„Åó„Åæ„Åó„Çá„ÅÜ</p>
                    <button class="btn-add-root" id="btn-add-root">KPI„ÉÑ„É™„Éº„Çí‰Ωú„Çã</button>
                </div>
            </div>
            <div id="canvas" class="canvas hidden">
                <div class="canvas-content">
                    <svg class="connections" id="connections"></svg>
                    <div id="nodes-container"></div>
                </div>
            </div>
        </div>

        <!-- „Éí„É≥„Éà„Éë„Éç„É´ -->
        <div id="hint-panel" class="hint-panel hidden">
            <div class="hint-header">
                <h3 class="hint-title">KPI„Éí„É≥„Éà</h3>
                <button class="close-btn" id="close-hints">‚úï</button>
            </div>
            <div class="node-info">
                <div class="node-info-name" id="selected-node-name"></div>
                <div class="node-info-desc" id="selected-node-desc"></div>
            </div>
            <div class="hints-content">
                <div class="hints-subtitle" id="hints-subtitle"></div>
                <div id="hints-list"></div>
                <div id="no-hints" class="no-hints hidden">
                    <div class="no-hints-icon">üí°</div>
                    <div class="no-hints-text">
                        „Åì„ÅÆKPI„ÅÆ„Éí„É≥„Éà„ÅØÁèæÂú®Ê∫ñÂÇô‰∏≠„Åß„Åô„ÄÇ<br/>
                        ÊâãÂãï„ÅßÂ≠êKPI„ÇíËøΩÂä†„Åô„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ
                    </div>
                    <button class="btn-manual-add" id="btn-manual-add">ÊâãÂãï„ÅßKPI„ÇíËøΩÂä†</button>
                </div>
            </div>
            <div class="hint-footer">
                <div class="hint-tip">üí° „Éí„É≥„Éà: KPI„Çí„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÂêçÂâç„ÇíÁ∑®ÈõÜ„Åß„Åç„Åæ„Åô</div>
            </div>
        </div>
    </div>

    <!-- Êï∞ÂÄ§ÂÖ•Âäõ„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
    <div id="value-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Êï∞ÂÄ§Ë®≠ÂÆö</h3>
                <button class="close-btn" id="close-modal">‚úï</button>
            </div>
            <div id="value-form" class="modal-body">
                <div class="form-group">
                    <label class="form-label">ÁõÆÊ®ôÂÄ§</label>
                    <input type="number" class="form-input" id="target-input" placeholder="ÁõÆÊ®ôÂÄ§„ÇíÂÖ•Âäõ">
                </div>
                <div class="form-group">
                    <label class="form-label">ÂÆüÁ∏æÂÄ§</label>
                    <input type="number" class="form-input" id="value-input" placeholder="ÁèæÂú®„ÅÆÂÆüÁ∏æÂÄ§„ÇíÂÖ•Âäõ">
                </div>
                <div class="form-group">
                    <label class="form-label">Âçò‰Ωç</label>
                    <input type="text" class="form-input" id="unit-input" placeholder="‰æã: ÂÜÜ„ÄÅ‰ª∂„ÄÅ‰∫∫">
                </div>
                <div class="calculation-assistant">
                    <div class="calculation-title">ü§ñ „Ç§„É≥„ÉÜ„É™„Ç∏„Çß„É≥„ÉàË®àÁÆó</div>
                    <div class="calculation-description">‰∏ä‰ΩçKPI„ÅÆÊÉÖÂ†±„Åã„ÇâËá™ÂãïÁöÑ„Å´ÁõÆÊ®ôÂÄ§„ÇíÁÆóÂá∫„Åó„Åæ„Åô</div>
                    <button class="btn btn-secondary" id="btn-calculation">Ë®àÁÆó„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Çí‰ΩøÁî®</button>
                </div>
            </div>
            <div id="calculation-form" class="modal-body hidden">
                <div class="calculation-screen">
                    <div class="calculation-icon">üßÆ</div>
                    <div class="calculation-step-title">„Ç§„É≥„ÉÜ„É™„Ç∏„Çß„É≥„ÉàË®àÁÆó</div>
                    <div class="calculation-step-desc">„ÅÑ„Åè„Å§„Åã„ÅÆË≥™Âïè„Å´„ÅäÁ≠î„Åà„Åè„Å†„Åï„ÅÑ</div>
                </div>
                <div class="form-group">
                    <label class="form-label" id="parent-question">‰∏ä‰ΩçKPI„ÅÆÁõÆÊ®ôÂÄ§„ÅØ„ÅÑ„Åè„Çâ„Åß„Åô„ÅãÔºü</label>
                    <input type="number" class="form-input" id="parent-value" placeholder="‰æã: 5000‰∏áÂÜÜ„ÅÆÂ†¥Âêà„ÅØ 50000000">
                </div>
                <div class="form-group">
                    <label class="form-label" id="child-question">ÈÅéÂéª„ÅÆÂπ≥ÂùáÂÄ§„ÅØ„ÅÑ„Åè„Çâ„Åß„Åó„Åü„ÅãÔºü</label>
                    <input type="number" class="form-input" id="child-estimate" placeholder="‰æã: Âπ≥ÂùáÂçò‰æ°50‰∏áÂÜÜ„ÅÆÂ†¥Âêà„ÅØ 500000">
                </div>
                <div class="calculation-example">
                    <div class="calculation-example-text">üí° Ë®àÁÆó‰æã: Â£≤‰∏ä5000‰∏áÂÜÜ √∑ Âπ≥ÂùáÂçò‰æ°50‰∏áÂÜÜ = ÁõÆÊ®ô‰ª∂Êï∞100‰ª∂</div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn-back btn-flex" id="btn-back">Êàª„Çã</button>
                    <button class="btn-calculate btn-flex" id="btn-calculate" disabled>Ë®àÁÆóÂÆüË°å</button>
                </div>
            </div>
            <div id="value-footer" class="modal-footer">
                <button class="btn-cancel btn-flex" id="btn-cancel">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="btn-save btn-flex" id="btn-save">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <script>
        // KPI„Éí„É≥„Éà„Éá„Éº„Çø
        const kpiHints = {
            'Â£≤‰∏ä': [
                {
                    id: 'customers',
                    name: 'È°ßÂÆ¢Êï∞',
                    description: 'Â£≤‰∏ä„ÇíÁîü„ÅøÂá∫„ÅôÈ°ßÂÆ¢„ÅÆÁ∑èÊï∞„ÄÇÊñ∞Ë¶è„ÉªÊó¢Â≠ò„Å´ÂàÜ„Åë„Å¶ÁÆ°ÁêÜ„Åô„Çã„Åì„Å®„ÅåÈáçË¶Å„Åß„Åô„ÄÇ',
                    formula: 'Â£≤‰∏ä = È°ßÂÆ¢Êï∞ √ó È°ßÂÆ¢Âçò‰æ°',
                    examples: ['ÊúàÈñì„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É¶„Éº„Ç∂„ÉºÊï∞', 'Â•ëÁ¥Ñ‰ºÅÊ•≠Êï∞', '‰ºöÂì°Êï∞'],
                    category: 'customer'
                },
                {
                    id: 'customer_price',
                    name: 'È°ßÂÆ¢Âçò‰æ°',
                    description: '‰∏Ä‰∫∫„ÅÆÈ°ßÂÆ¢„ÅåÂπ≥ÂùáÁöÑ„Å´ÊîØÊâï„ÅÜÈáëÈ°ç„ÄÇLTVÔºàÈ°ßÂÆ¢ÁîüÊ∂Ø‰æ°ÂÄ§Ôºâ„ÅÆÂü∫Á§é„Å®„Å™„Çä„Åæ„Åô„ÄÇ',
                    formula: 'Â£≤‰∏ä = È°ßÂÆ¢Êï∞ √ó È°ßÂÆ¢Âçò‰æ°',
                    examples: ['ARPUÔºàAverage Revenue Per UserÔºâ', 'Âπ≥ÂùáÊ≥®ÊñáÈáëÈ°ç', 'Â•ëÁ¥ÑÂçò‰æ°'],
                    category: 'revenue'
                },
                {
                    id: 'contracts',
                    name: 'ÊàêÁ¥ÑÊï∞',
                    description: 'ÂÆüÈöõ„Å´Â•ëÁ¥Ñ„ÇÑË≥ºÂÖ•„Å´Ëá≥„Å£„Åü‰ª∂Êï∞„ÄÇÊàêÁ¥ÑÁéá„Å®ÁµÑ„ÅøÂêà„Çè„Åõ„Å¶ÂàÜÊûê„Åó„Åæ„Åô„ÄÇ',
                    formula: 'Â£≤‰∏ä = ÊàêÁ¥ÑÊï∞ √ó Âπ≥ÂùáÂ•ëÁ¥ÑÈáëÈ°ç',
                    examples: ['ÊúàÈñìÊàêÁ¥Ñ‰ª∂Êï∞', 'Êñ∞Ë¶èÂ•ëÁ¥ÑÊï∞', '„Ç™„Éº„ÉÄ„ÉºÊï∞'],
                    category: 'revenue'
                },
                {
                    id: 'profit_margin',
                    name: 'Âà©ÁõäÁéá',
                    description: 'Â£≤‰∏ä„Å´ÂØæ„Åô„ÇãÂà©Áõä„ÅÆÂâ≤Âêà„ÄÇÂèéÁõäÊÄß„ÇíÊ∏¨„ÇãÈáçË¶Å„Å™ÊåáÊ®ô„Åß„Åô„ÄÇ',
                    formula: 'Âà©ÁõäÁéá = (Â£≤‰∏ä - Ë≤ªÁî®) √∑ Â£≤‰∏ä',
                    examples: ['Á≤óÂà©ÁõäÁéá', 'Âñ∂Ê•≠Âà©ÁõäÁéá', 'Á¥îÂà©ÁõäÁéá'],
                    category: 'profitability'
                }
            ],
            'È°ßÂÆ¢Êï∞': [
                {
                    id: 'new_customers',
                    name: 'Êñ∞Ë¶èÈ°ßÂÆ¢Êï∞',
                    description: 'Êñ∞„Åü„Å´Áç≤Âæó„Åó„ÅüÈ°ßÂÆ¢„ÅÆÊï∞„ÄÇÊàêÈï∑„ÅÆÂéüÂãïÂäõ„Å®„Å™„ÇãÈáçË¶ÅÊåáÊ®ô„Åß„Åô„ÄÇ',
                    formula: 'È°ßÂÆ¢Êï∞ = Êñ∞Ë¶èÈ°ßÂÆ¢Êï∞ + Êó¢Â≠òÈ°ßÂÆ¢Êï∞',
                    examples: ['ÊúàÈñìÊñ∞Ë¶èÁôªÈå≤Êï∞', 'Êñ∞Ë¶èÂ•ëÁ¥Ñ‰ºÅÊ•≠Êï∞', 'ÂàùÂõûË≥ºÂÖ•ËÄÖÊï∞'],
                    category: 'customer'
                },
                {
                    id: 'existing_customers',
                    name: 'Êó¢Â≠òÈ°ßÂÆ¢Êï∞',
                    description: 'Á∂ôÁ∂öÂà©Áî®„Åó„Å¶„ÅÑ„ÇãÈ°ßÂÆ¢„ÅÆÊï∞„ÄÇ„É™„ÉÜ„É≥„Ç∑„Éß„É≥Áéá„Å®ÂØÜÊé•„Å´Èñ¢‰øÇ„Åó„Åæ„Åô„ÄÇ',
                    formula: 'È°ßÂÆ¢Êï∞ = Êñ∞Ë¶èÈ°ßÂÆ¢Êï∞ + Êó¢Â≠òÈ°ßÂÆ¢Êï∞',
                    examples: ['„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É¶„Éº„Ç∂„ÉºÊï∞', 'Á∂ôÁ∂öÂ•ëÁ¥ÑÊï∞', '„É™„Éî„Éº„Çø„ÉºÊï∞'],
                    category: 'customer'
                },
                {
                    id: 'retention_rate',
                    name: 'È°ßÂÆ¢Á∂ôÁ∂öÁéá',
                    description: 'Êó¢Â≠òÈ°ßÂÆ¢„ÅåÁ∂ôÁ∂ö„Åó„Å¶Âà©Áî®„Åó„Å¶„ÅÑ„ÇãÂâ≤Âêà„ÄÇÈ°ßÂÆ¢„É≠„Ç§„É§„É´„ÉÜ„Ç£„ÅÆÊåáÊ®ô„Åß„Åô„ÄÇ',
                    formula: 'Á∂ôÁ∂öÁéá = Á∂ôÁ∂öÈ°ßÂÆ¢Êï∞ √∑ ÊúüÂàùÈ°ßÂÆ¢Êï∞',
                    examples: ['ÊúàÊ¨°Á∂ôÁ∂öÁéá', 'Âπ¥Ê¨°Á∂ôÁ∂öÁéá', '„ÉÅ„É£„Éº„É≥Áéá'],
                    category: 'customer'
                }
            ],
            'ÊàêÁ¥ÑÊï∞': [
                {
                    id: 'proposals',
                    name: 'ÊèêÊ°àÊï∞',
                    description: 'È°ßÂÆ¢„Å´ÂØæ„Åó„Å¶Ë°å„Å£„ÅüÊèêÊ°à„ÅÆÊï∞„ÄÇÂïÜË´áÊ©ü‰ºö„ÅÆÂâµÂá∫Âäõ„ÇíË°®„Åó„Åæ„Åô„ÄÇ',
                    formula: 'ÊàêÁ¥ÑÊï∞ = ÊèêÊ°àÊï∞ √ó ÊèêÊ°àÊàêÁ¥ÑÁéá',
                    examples: ['Ë¶ãÁ©çÊèêÂá∫Êï∞', '„Éó„É¨„Çº„É≥ÂÆüÊñΩÊï∞', 'ÂïÜË´áÊï∞'],
                    category: 'marketing'
                },
                {
                    id: 'conversion_rate',
                    name: 'ÊàêÁ¥ÑÁéá',
                    description: 'ÊèêÊ°à„Åã„ÇâÊàêÁ¥Ñ„Å´Ëá≥„ÇãÂâ≤Âêà„ÄÇÂñ∂Ê•≠ÂäπÁéá„ÇíÊ∏¨„ÇãÈáçË¶Å„Å™ÊåáÊ®ô„Åß„Åô„ÄÇ',
                    formula: 'ÊàêÁ¥ÑÁéá = ÊàêÁ¥ÑÊï∞ √∑ ÊèêÊ°àÊï∞',
                    examples: ['ÂïÜË´áÊàêÁ¥ÑÁéá', 'Ë¶ãÁ©çÊàêÁ¥ÑÁéá', '„ÇØ„É≠„Éº„Ç∏„É≥„Ç∞Áéá'],
                    category: 'sales'
                }
            ],
            'È°ßÂÆ¢Âçò‰æ°': [
                {
                    id: 'purchase_frequency',
                    name: 'Ë≥ºÂÖ•È†ªÂ∫¶',
                    description: 'È°ßÂÆ¢„Åå‰∏ÄÂÆöÊúüÈñìÂÜÖ„Å´Ë≥ºÂÖ•„Åô„ÇãÂõûÊï∞„ÄÇ„É™„Éî„Éº„ÉàÊÄß„ÇíÊ∏¨„ÇãÊåáÊ®ô„Åß„Åô„ÄÇ',
                    formula: 'È°ßÂÆ¢Âçò‰æ° = Âπ≥ÂùáÊ≥®ÊñáÈáëÈ°ç √ó Ë≥ºÂÖ•È†ªÂ∫¶',
                    examples: ['ÊúàÈñìË≥ºÂÖ•ÂõûÊï∞', 'Âπ¥ÈñìË≥ºÂÖ•ÂõûÊï∞', '„É™„Éî„Éº„ÉàÁéá'],
                    category: 'customer'
                },
                {
                    id: 'average_order_value',
                    name: 'Âπ≥ÂùáÊ≥®ÊñáÈáëÈ°ç',
                    description: '1Âõû„ÅÆÊ≥®Êñá„ÅÇ„Åü„Çä„ÅÆÂπ≥ÂùáÈáëÈ°ç„ÄÇÂÆ¢Âçò‰æ°„ÅÆÂü∫Á§é„Å®„Å™„ÇãÊåáÊ®ô„Åß„Åô„ÄÇ',
                    formula: 'È°ßÂÆ¢Âçò‰æ° = Âπ≥ÂùáÊ≥®ÊñáÈáëÈ°ç √ó Ë≥ºÂÖ•È†ªÂ∫¶',
                    examples: ['AOV', 'ÂÆ¢Âçò‰æ°', '„Éê„Çπ„Ç±„ÉÉ„ÉàÂçò‰æ°'],
                    category: 'revenue'
                }
            ],
            'Êñ∞Ë¶èÈ°ßÂÆ¢Êï∞': [
                {
                    id: 'leads',
                    name: '„É™„Éº„ÉâÊï∞',
                    description: 'Ë¶ãËæº„ÅøÈ°ßÂÆ¢„ÅÆÁ∑èÊï∞„ÄÇ„Éû„Éº„Ç±„ÉÜ„Ç£„É≥„Ç∞Ê¥ªÂãï„ÅÆÊàêÊûú„ÇíË°®„Åó„Åæ„Åô„ÄÇ',
                    formula: 'Êñ∞Ë¶èÈ°ßÂÆ¢Êï∞ = „É™„Éº„ÉâÊï∞ √ó „Ç≥„É≥„Éê„Éº„Ç∏„Éß„É≥Áéá',
                    examples: ['Âïè„ÅÑÂêà„Çè„ÅõÊï∞', 'Ë≥áÊñôË´ãÊ±ÇÊï∞', '„Çª„Éü„Éä„ÉºÂèÇÂä†ËÄÖÊï∞'],
                    category: 'marketing'
                },
                {
                    id: 'conversion_from_leads',
                    name: '„É™„Éº„Éâ„Ç≥„É≥„Éê„Éº„Ç∏„Éß„É≥Áéá',
                    description: '„É™„Éº„Éâ„Åã„ÇâÈ°ßÂÆ¢„Å´„Å™„ÇãÂâ≤Âêà„ÄÇ„Éû„Éº„Ç±„ÉÜ„Ç£„É≥„Ç∞„Åã„ÇâÂñ∂Ê•≠„Å∏„ÅÆÂäπÁéá„ÇíË°®„Åó„Åæ„Åô„ÄÇ',
                    formula: 'Êñ∞Ë¶èÈ°ßÂÆ¢Êï∞ = „É™„Éº„ÉâÊï∞ √ó „Ç≥„É≥„Éê„Éº„Ç∏„Éß„É≥Áéá',
                    examples: ['MQL to SQLÁéá', 'SQL to CustomerÁéá', 'ÂÖ®‰ΩìCVÁéá'],
                    category: 'sales'
                }
            ],
            '„É™„Éº„ÉâÊï∞': [
                {
                    id: 'website_visitors',
                    name: 'Web„Çµ„Ç§„ÉàË®™ÂïèËÄÖÊï∞',
                    description: 'Web„Çµ„Ç§„Éà„Å∏„ÅÆË®™ÂïèËÄÖÊï∞„ÄÇ„Éá„Ç∏„Çø„É´„Éû„Éº„Ç±„ÉÜ„Ç£„É≥„Ç∞„ÅÆËµ∑ÁÇπ„Å®„Å™„ÇãÊåáÊ®ô„Åß„Åô„ÄÇ',
                    formula: '„É™„Éº„ÉâÊï∞ = Ë®™ÂïèËÄÖÊï∞ √ó „É™„Éº„ÉâÁç≤ÂæóÁéá',
                    examples: ['„É¶„Éã„Éº„ÇØ„Éì„Ç∏„Çø„ÉºÊï∞', '„Çª„ÉÉ„Ç∑„Éß„É≥Êï∞', 'PVÊï∞'],
                    category: 'marketing'
                },
                {
                    id: 'lead_acquisition_rate',
                    name: '„É™„Éº„ÉâÁç≤ÂæóÁéá',
                    description: '„Çµ„Ç§„ÉàË®™ÂïèËÄÖ„Åå„É™„Éº„Éâ„Å´„Å™„ÇãÂâ≤Âêà„ÄÇ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆÈ≠ÖÂäõÂ∫¶„ÇíË°®„Åó„Åæ„Åô„ÄÇ',
                    formula: '„É™„Éº„ÉâÊï∞ = Ë®™ÂïèËÄÖÊï∞ √ó „É™„Éº„ÉâÁç≤ÂæóÁéá',
                    examples: ['„Éï„Ç©„Éº„É†ÈÄÅ‰ø°Áéá', '„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÁéá', '„É°„É´„Éû„Ç¨ÁôªÈå≤Áéá'],
                    category: 'marketing'
                }
            ],
            'ÊèêÊ°àÊï∞': [
                {
                    id: 'qualified_leads',
                    name: 'ÊúâÂäπ„É™„Éº„ÉâÊï∞',
                    description: 'Âñ∂Ê•≠Ê¥ªÂãï„Å´ÂÄ§„Åô„ÇãË≥™„ÅÆÈ´ò„ÅÑ„É™„Éº„ÉâÊï∞„ÄÇÂñ∂Ê•≠ÂäπÁéá„Å´Áõ¥Áµê„Åó„Åæ„Åô„ÄÇ',
                    formula: 'ÊèêÊ°àÊï∞ = ÊúâÂäπ„É™„Éº„ÉâÊï∞ √ó ÊèêÊ°àÁéá',
                    examples: ['SQLÊï∞', 'BANT„É™„Éº„ÉâÊï∞', '„Éõ„ÉÉ„Éà„É™„Éº„ÉâÊï∞'],
                    category: 'sales'
                },
                {
                    id: 'proposal_rate',
                    name: 'ÊèêÊ°àÁéá',
                    description: 'ÊúâÂäπ„É™„Éº„Éâ„Åã„ÇâÊèêÊ°à„Å´Ëá≥„ÇãÂâ≤Âêà„ÄÇÂñ∂Ê•≠„Éó„É≠„Çª„Çπ„ÅÆÂäπÁéá„ÇíË°®„Åó„Åæ„Åô„ÄÇ',
                    formula: 'ÊèêÊ°àÊï∞ = ÊúâÂäπ„É™„Éº„ÉâÊï∞ √ó ÊèêÊ°àÁéá',
                    examples: ['ÂïÜË´áÂåñÁéá', '„Éã„Éº„Ç∫„Éí„Ç¢„É™„É≥„Ç∞Áéá', '„Éá„É¢ÂÆüÊñΩÁéá'],
                    category: 'sales'
                }
            ],
            'Âà©ÁõäÁéá': [
                {
                    id: 'cost_of_sales',
                    name: 'Â£≤‰∏äÂéü‰æ°Áéá',
                    description: 'Â£≤‰∏ä„Å´ÂØæ„Åô„ÇãÂéü‰æ°„ÅÆÂâ≤Âêà„ÄÇÂïÜÂìÅ„Éª„Çµ„Éº„Éì„Çπ„ÅÆÂéü‰æ°ÂäπÁéá„ÇíË°®„Åó„Åæ„Åô„ÄÇ',
                    formula: 'Âà©ÁõäÁéá = 1 - (Â£≤‰∏äÂéü‰æ°Áéá + Ë≤©ÁÆ°Ë≤ªÁéá)',
                    examples: ['ÂéüÊùêÊñôË≤ªÁéá', 'Ë£ΩÈÄ†Ë≤ªÁéá', '‰ªïÂÖ•Âéü‰æ°Áéá'],
                    category: 'cost'
                },
                {
                    id: 'operating_expense_ratio',
                    name: 'Ë≤©ÁÆ°Ë≤ªÁéá',
                    description: 'Â£≤‰∏ä„Å´ÂØæ„Åô„ÇãË≤©Â£≤ÁÆ°ÁêÜË≤ª„ÅÆÂâ≤Âêà„ÄÇÈÅãÂñ∂ÂäπÁéá„ÇíË°®„Åó„Åæ„Åô„ÄÇ',
                    formula: 'Âà©ÁõäÁéá = 1 - (Â£≤‰∏äÂéü‰æ°Áéá + Ë≤©ÁÆ°Ë≤ªÁéá)',
                    examples: ['‰∫∫‰ª∂Ë≤ªÁéá', 'Â∫ÉÂëäË≤ªÁéá', '‰∏ÄËà¨ÁÆ°ÁêÜË≤ªÁéá'],
                    category: 'cost'
                }
            ],
            'Web„Çµ„Ç§„ÉàË®™ÂïèËÄÖÊï∞': [
                {
                    id: 'organic_traffic',
                    name: '„Ç™„Éº„Ç¨„Éã„ÉÉ„ÇØÊµÅÂÖ•',
                    description: 'Ê§úÁ¥¢„Ç®„É≥„Ç∏„É≥„Åã„Çâ„ÅÆËá™ÁÑ∂ÊµÅÂÖ•„ÄÇSEOÂäπÊûú„ÇíÊ∏¨„ÇãÊåáÊ®ô„Åß„Åô„ÄÇ',
                    formula: 'Ë®™ÂïèËÄÖÊï∞ = „Ç™„Éº„Ç¨„Éã„ÉÉ„ÇØÊµÅÂÖ• + ÊúâÊñôÊµÅÂÖ• + „Åù„ÅÆ‰ªñÊµÅÂÖ•',
                    examples: ['GoogleÊ§úÁ¥¢ÊµÅÂÖ•', 'YahooÊ§úÁ¥¢ÊµÅÂÖ•', 'SEOÊµÅÂÖ•'],
                    category: 'marketing'
                },
                {
                    id: 'paid_traffic',
                    name: 'ÊúâÊñôÂ∫ÉÂëäÊµÅÂÖ•',
                    description: 'Â∫ÉÂëä„Åã„Çâ„ÅÆÊµÅÂÖ•„ÄÇÂ∫ÉÂëäÊäïË≥á„ÅÆÂäπÊûú„ÇíË°®„Åó„Åæ„Åô„ÄÇ',
                    formula: 'Ë®™ÂïèËÄÖÊï∞ = „Ç™„Éº„Ç¨„Éã„ÉÉ„ÇØÊµÅÂÖ• + ÊúâÊñôÊµÅÂÖ• + „Åù„ÅÆ‰ªñÊµÅÂÖ•',
                    examples: ['GoogleÂ∫ÉÂëäÊµÅÂÖ•', 'FacebookÂ∫ÉÂëäÊµÅÂÖ•', '„Éá„Ç£„Çπ„Éó„É¨„Ç§Â∫ÉÂëäÊµÅÂÖ•'],
                    category: 'marketing'
                },
                {
                    id: 'referral_traffic',
                    name: 'ÂèÇÁÖß„Çµ„Ç§„ÉàÊµÅÂÖ•',
                    description: '‰ªñ„Çµ„Ç§„Éà„Åã„Çâ„ÅÆÊµÅÂÖ•„ÄÇÂ§ñÈÉ®ÈÄ£Êê∫„ÇÑPRÂäπÊûú„ÇíË°®„Åó„Åæ„Åô„ÄÇ',
                    formula: 'Ë®™ÂïèËÄÖÊï∞ = „Ç™„Éº„Ç¨„Éã„ÉÉ„ÇØÊµÅÂÖ• + ÊúâÊñôÊµÅÂÖ• + „Åù„ÅÆ‰ªñÊµÅÂÖ•',
                    examples: ['SNSÊµÅÂÖ•', '„É°„Éá„Ç£„Ç¢Êé≤ËºâÊµÅÂÖ•', '„Éë„Éº„Éà„Éä„Éº„Çµ„Ç§„ÉàÊµÅÂÖ•'],
                    category: 'marketing'
                }
            ]
        };

        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Áä∂ÊÖã
        let kpiTree = null;
        let selectedNode = null;
        let draggedNode = null;
        let dragOffset = { x: 0, y: 0 };
        let selectedHintId = null;
        let calculationStep = 0;
        let calculationData = { parentValue: '', childEstimate: '' };

        // DOMË¶ÅÁ¥†„ÅÆÂèñÂæó
        const elements = {
            emptyState: document.getElementById('empty-state'),
            canvas: document.getElementById('canvas'),
            nodesContainer: document.getElementById('nodes-container'),
            connections: document.getElementById('connections'),
            hintPanel: document.getElementById('hint-panel'),
            valueModal: document.getElementById('value-modal'),
            treeName: document.getElementById('tree-name'),
            btnAddRoot: document.getElementById('btn-add-root'),
            btnSettings: document.getElementById('btn-settings'),
            closeHints: document.getElementById('close-hints'),
            closeModal: document.getElementById('close-modal'),
            selectedNodeName: document.getElementById('selected-node-name'),
            selectedNodeDesc: document.getElementById('selected-node-desc'),
            hintsSubtitle: document.getElementById('hints-subtitle'),
            hintsList: document.getElementById('hints-list'),
            noHints: document.getElementById('no-hints'),
            btnManualAdd: document.getElementById('btn-manual-add'),
            modalTitle: document.getElementById('modal-title'),
            valueForm: document.getElementById('value-form'),
            calculationForm: document.getElementById('calculation-form'),
            valueFooter: document.getElementById('value-footer'),
            targetInput: document.getElementById('target-input'),
            valueInput: document.getElementById('value-input'),
            unitInput: document.getElementById('unit-input'),
            btnCalculation: document.getElementById('btn-calculation'),
            parentQuestion: document.getElementById('parent-question'),
            childQuestion: document.getElementById('child-question'),
            parentValue: document.getElementById('parent-value'),
            childEstimate: document.getElementById('child-estimate'),
            btnBack: document.getElementById('btn-back'),
            btnCalculate: document.getElementById('btn-calculate'),
            btnCancel: document.getElementById('btn-cancel'),
            btnSave: document.getElementById('btn-save')
        };

        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
        function generateId() {
            return 'node-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        function getCategoryLabel(category) {
            const labels = { 
                customer: 'È°ßÂÆ¢', 
                revenue: 'Â£≤‰∏ä', 
                marketing: '„Éû„Éº„Ç±', 
                sales: 'Âñ∂Ê•≠',
                profitability: 'ÂèéÁõäÊÄß',
                cost: '„Ç≥„Çπ„Éà'
            };
            return labels[category] || category;
        }

        // KPI„ÉÑ„É™„ÉºÊìç‰ΩúÈñ¢Êï∞
        function addRootNode() {
            const rootNode = {
                id: 'root',
                name: 'Â£≤‰∏ä',
                level: 0,
                x: 400,
                y: 100,
                children: [],
                description: '„Éì„Ç∏„Éç„Çπ„ÅÆ‰∏ªË¶ÅÁõÆÊ®ôÊåáÊ®ô'
            };

            kpiTree = {
                id: 'tree-1',
                name: 'Êñ∞Ë¶èKPI„ÉÑ„É™„Éº',
                nodes: { root: rootNode },
                rootNodeId: 'root'
            };

            selectedNode = rootNode;
            renderTree();
            showHints();
            
            elements.treeName.textContent = kpiTree.name;
            elements.btnSettings.disabled = false;
        }

        function addChildNode(parentId, childData) {
            if (!kpiTree) return;

            const childId = generateId();
            const parentNode = kpiTree.nodes[parentId];
            
            const childNode = {
                id: childId,
                name: childData.name || 'Êñ∞„Åó„ÅÑKPI',
                level: parentNode.level + 1,
                x: parentNode.x + (parentNode.children.length * 200) - 100,
                y: parentNode.y + 150,
                children: [],
                parent: parentId,
                description: childData.description,
                formula: childData.formula
            };

            parentNode.children.push(childId);
            kpiTree.nodes[childId] = childNode;

            selectedNode = childNode;
            renderTree();
            showHints();
        }

        function updateNode(nodeId, updates) {
            if (!kpiTree || !kpiTree.nodes[nodeId]) return;
            
            Object.assign(kpiTree.nodes[nodeId], updates);
            renderTree();
        }

        function deleteNode(nodeId) {
            if (!kpiTree || !kpiTree.nodes[nodeId] || nodeId === 'root') return;
            
            const node = kpiTree.nodes[nodeId];
            
            // Â≠ê„Éé„Éº„Éâ„ÇíÂÜçÂ∏∞ÁöÑ„Å´ÂâäÈô§
            if (node.children && node.children.length > 0) {
                [...node.children].forEach(childId => deleteNode(childId));
            }
            
            // Ë¶™„Éé„Éº„Éâ„Åã„ÇâËá™ÂàÜ„ÇíÂâäÈô§
            if (node.parent && kpiTree.nodes[node.parent]) {
                const parentNode = kpiTree.nodes[node.parent];
                parentNode.children = parentNode.children.filter(childId => childId !== nodeId);
            }
            
            // „Éé„Éº„Éâ„ÇíÂâäÈô§
            delete kpiTree.nodes[nodeId];
            
            // ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åü„Éé„Éº„Éâ„ÅåÂâäÈô§„Åï„Çå„ÅüÂ†¥Âêà
            if (selectedNode && selectedNode.id === nodeId) {
                selectedNode = null;
                elements.hintPanel.classList.add('hidden');
                elements.btnSettings.disabled = true;
            }
            
            renderTree();
        }

        function selectNode(node) {
            selectedNode = node;
            renderTree();
            showHints();
        }

        // „É¨„É≥„ÉÄ„É™„É≥„Ç∞Èñ¢Êï∞
        function renderTree() {
            if (!kpiTree || Object.keys(kpiTree.nodes).length === 0) {
                elements.emptyState.classList.remove('hidden');
                elements.canvas.classList.add('hidden');
                elements.hintPanel.classList.add('hidden');
                return;
            }

            elements.emptyState.classList.add('hidden');
            elements.canvas.classList.remove('hidden');

            renderConnections();
            renderNodes();
        }

        function renderConnections() {
            const svg = elements.connections;
            svg.innerHTML = '';

            Object.values(kpiTree.nodes).forEach(parent => {
                parent.children.forEach(childId => {
                    const child = kpiTree.nodes[childId];
                    if (!child) return;

                    const parentCenterX = parent.x + 100;
                    const parentCenterY = parent.y + 40;
                    const childCenterX = child.x + 100;
                    const childCenterY = child.y + 40;

                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', parentCenterX);
                    line.setAttribute('y1', parentCenterY);
                    line.setAttribute('x2', childCenterX);
                    line.setAttribute('y2', childCenterY);
                    line.setAttribute('stroke', '#e2e8f0');
                    line.setAttribute('stroke-width', '2');

                    const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                    arrow.setAttribute('points', `${childCenterX-5},${childCenterY-5} ${childCenterX+5},${childCenterY-5} ${childCenterX},${childCenterY+5}`);
                    arrow.setAttribute('fill', '#e2e8f0');

                    svg.appendChild(line);
                    svg.appendChild(arrow);
                });
            });
        }

        function renderNodes() {
            const container = elements.nodesContainer;
            container.innerHTML = '';

            Object.values(kpiTree.nodes).forEach(node => {
                const nodeElement = createNodeElement(node);
                container.appendChild(nodeElement);
            });
        }

        function createNodeElement(node) {
            const isSelected = selectedNode?.id === node.id;
            
            const nodeDiv = document.createElement('div');
            nodeDiv.className = `node ${isSelected ? 'selected' : ''}`;
            nodeDiv.style.left = node.x + 'px';
            nodeDiv.style.top = node.y + 'px';

            const values = [];
            if (node.value) values.push(`<div class="node-value">ÂÆüÁ∏æ: ${node.value}${node.unit || ''}</div>`);
            if (node.target) values.push(`<div class="node-target">ÁõÆÊ®ô: ${node.target}${node.unit || ''}</div>`);

            nodeDiv.innerHTML = `
                <div class="node-content">
                    <div class="node-name">${node.name}</div>
                    ${node.description ? `<div class="node-description">${node.description}</div>` : ''}
                    ${values.length > 0 ? `<div class="node-values">${values.join('')}</div>` : ''}
                    ${node.formula ? `<div class="node-formula">${node.formula}</div>` : ''}
                </div>
                <button class="add-child-btn" title="Â≠êKPI„ÇíËøΩÂä†">+</button>
                ${node.id !== 'root' ? '<button class="delete-btn" title="KPI„ÇíÂâäÈô§">üóëÔ∏è</button>' : ''}
            `;

            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            nodeDiv.addEventListener('click', () => selectNode(node));
            nodeDiv.addEventListener('dblclick', () => editNodeName(node));
            nodeDiv.addEventListener('mousedown', (e) => startDrag(e, node.id));

            const addBtn = nodeDiv.querySelector('.add-child-btn');
            addBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const name = prompt('KPIÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
                if (name) {
                    addChildNode(node.id, { name });
                }
            });

            const deleteBtn = nodeDiv.querySelector('.delete-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`„Äå${node.name}„Äç„Å®„Åù„ÅÆÂ≠êKPI„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                        deleteNode(node.id);
                    }
                });
            }

            return nodeDiv;
        }

        // „Éí„É≥„Éà„Éë„Éç„É´Èñ¢Êï∞
        function showHints() {
            if (!selectedNode) {
                elements.hintPanel.classList.add('hidden');
                return;
            }

            elements.hintPanel.classList.remove('hidden');
            elements.selectedNodeName.textContent = selectedNode.name;
            elements.selectedNodeDesc.textContent = selectedNode.description || '';
            elements.hintsSubtitle.textContent = `„Äå${selectedNode.name}„Äç„ÅÆ‰∏ã‰ΩçKPIÂÄôË£ú:`;

            const hints = kpiHints[selectedNode.name] || [];
            renderHints(hints);
        }

        function renderHints(hints) {
            const container = elements.hintsList;
            container.innerHTML = '';

            if (hints.length === 0) {
                elements.noHints.classList.remove('hidden');
                return;
            }

            elements.noHints.classList.add('hidden');

            hints.forEach(hint => {
                const hintElement = createHintElement(hint);
                container.appendChild(hintElement);
            });
        }

        function createHintElement(hint) {
            const isSelected = selectedHintId === hint.id;
            
            const hintDiv = document.createElement('div');
            hintDiv.className = `hint-item ${isSelected ? 'selected' : ''}`;

            const examples = hint.examples.map(ex => `<li>${ex}</li>`).join('');

            hintDiv.innerHTML = `
                <div class="hint-header-row">
                    <div class="hint-name">${hint.name}</div>
                    <div class="hint-category">${getCategoryLabel(hint.category)}</div>
                </div>
                <div class="hint-description">${hint.description}</div>
                <div class="hint-formula">${hint.formula}</div>
                ${isSelected ? `
                    <div class="hint-details">
                        <div class="hint-examples-title">ÂÖ∑‰Ωì‰æã:</div>
                        <ul class="hint-examples">${examples}</ul>
                        <button class="btn-add-hint">„Åì„ÅÆKPI„ÇíËøΩÂä†</button>
                    </div>
                ` : ''}
            `;

            hintDiv.addEventListener('click', () => {
                selectedHintId = selectedHintId === hint.id ? null : hint.id;
                renderHints(kpiHints[selectedNode.name] || []);
            });

            if (isSelected) {
                const addBtn = hintDiv.querySelector('.btn-add-hint');
                addBtn.addEventListener('click', () => {
                    addChildNode(selectedNode.id, hint);
                    selectedHintId = null;
                });
            }

            return hintDiv;
        }

        // „Éâ„É©„ÉÉ„Ç∞Ê©üËÉΩ
        function startDrag(e, nodeId) {
            draggedNode = nodeId;
            const rect = e.currentTarget.getBoundingClientRect();
            dragOffset = {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        function handleMouseMove(e) {
            if (!draggedNode) return;
            
            const rect = elements.canvas.getBoundingClientRect();
            const newX = e.clientX - rect.left - dragOffset.x;
            const newY = e.clientY - rect.top - dragOffset.y;

            updateNode(draggedNode, { x: newX, y: newY });
        }

        function handleMouseUp() {
            draggedNode = null;
        }

        // „É¢„Éº„ÉÄ„É´Èñ¢Êï∞
        function showValueModal() {
            if (!selectedNode) return;

            elements.modalTitle.textContent = `Êï∞ÂÄ§Ë®≠ÂÆö - ${selectedNode.name}`;
            elements.targetInput.value = selectedNode.target || '';
            elements.valueInput.value = selectedNode.value || '';
            elements.unitInput.value = selectedNode.unit || '';
            
            showValueForm();
            elements.valueModal.classList.remove('hidden');
        }

        function hideValueModal() {
            elements.valueModal.classList.add('hidden');
            calculationStep = 0;
            calculationData = { parentValue: '', childEstimate: '' };
        }

        function showValueForm() {
            elements.valueForm.classList.remove('hidden');
            elements.calculationForm.classList.add('hidden');
            elements.valueFooter.classList.remove('hidden');
        }

        function showCalculationForm() {
            elements.valueForm.classList.add('hidden');
            elements.calculationForm.classList.remove('hidden');
            elements.valueFooter.classList.add('hidden');

            const parentNode = selectedNode.parent ? kpiTree.nodes[selectedNode.parent] : null;
            const parentName = parentNode ? parentNode.name : 'Â£≤‰∏ä';
            
            elements.parentQuestion.textContent = `‰∏ä‰ΩçKPI„Äå${parentName}„Äç„ÅÆÁõÆÊ®ôÂÄ§„ÅØ„ÅÑ„Åè„Çâ„Åß„Åô„ÅãÔºü`;
            elements.childQuestion.textContent = `ÈÅéÂéª„ÅÆ„Äå${selectedNode.name}„Äç„ÅÆÂπ≥ÂùáÂÄ§„ÅØ„ÅÑ„Åè„Çâ„Åß„Åó„Åü„ÅãÔºü`;
        }

        function calculateValue() {
            const parentVal = parseFloat(calculationData.parentValue);
            const childEst = parseFloat(calculationData.childEstimate);
            
            if (parentVal && childEst) {
                const calculated = Math.round(parentVal / childEst);
                updateNode(selectedNode.id, { target: calculated });
                hideValueModal();
            }
        }

        function editNodeName(node) {
            const newName = prompt('KPIÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', node.name);
            if (newName && newName !== node.name) {
                updateNode(node.id, { name: newName });
            }
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
        function setupEventListeners() {
            // „Éú„Çø„É≥„Ç§„Éô„É≥„Éà
            elements.btnAddRoot.addEventListener('click', addRootNode);
            elements.btnSettings.addEventListener('click', showValueModal);
            elements.closeHints.addEventListener('click', () => elements.hintPanel.classList.add('hidden'));
            elements.closeModal.addEventListener('click', hideValueModal);
            elements.btnManualAdd.addEventListener('click', () => {
                const name = prompt('KPIÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
                if (name) {
                    addChildNode(selectedNode.id, { name });
                }
            });

            // „É¢„Éº„ÉÄ„É´„Ç§„Éô„É≥„Éà
            elements.btnCalculation.addEventListener('click', showCalculationForm);
            elements.btnBack.addEventListener('click', showValueForm);
            elements.btnCancel.addEventListener('click', hideValueModal);
            elements.btnSave.addEventListener('click', () => {
                updateNode(selectedNode.id, {
                    target: parseFloat(elements.targetInput.value) || undefined,
                    value: parseFloat(elements.valueInput.value) || undefined,
                    unit: elements.unitInput.value || undefined
                });
                hideValueModal();
            });

            // Ë®àÁÆó„Éï„Ç©„Éº„É†„Ç§„Éô„É≥„Éà
            elements.parentValue.addEventListener('input', (e) => {
                calculationData.parentValue = e.target.value;
                updateCalculateButton();
            });
            elements.childEstimate.addEventListener('input', (e) => {
                calculationData.childEstimate = e.target.value;
                updateCalculateButton();
            });
            elements.btnCalculate.addEventListener('click', calculateValue);

            // Êï∞ÂÄ§ÂÖ•Âäõ„Éï„Ç©„Éº„É†„Ç§„Éô„É≥„Éà
            elements.targetInput.addEventListener('input', (e) => {
                if (selectedNode) {
                    updateNode(selectedNode.id, { target: parseFloat(e.target.value) || undefined });
                }
            });
            elements.valueInput.addEventListener('input', (e) => {
                if (selectedNode) {
                    updateNode(selectedNode.id, { value: parseFloat(e.target.value) || undefined });
                }
            });
            elements.unitInput.addEventListener('input', (e) => {
                if (selectedNode) {
                    updateNode(selectedNode.id, { unit: e.target.value || undefined });
                }
            });

            // „Éâ„É©„ÉÉ„Ç∞„Ç§„Éô„É≥„Éà
            elements.canvas.addEventListener('mousemove', handleMouseMove);
            elements.canvas.addEventListener('mouseup', handleMouseUp);
            elements.canvas.addEventListener('mouseleave', handleMouseUp);

            // „É¢„Éº„ÉÄ„É´„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇØ„É™„ÉÉ„ÇØ
            elements.valueModal.addEventListener('click', (e) => {
                if (e.target === elements.valueModal) {
                    hideValueModal();
                }
            });
        }

        function updateCalculateButton() {
            const hasValues = calculationData.parentValue && calculationData.childEstimate;
            elements.btnCalculate.disabled = !hasValues;
        }

        // ÂàùÊúüÂåñ
        function init() {
            setupEventListeners();
            renderTree();
        }

        // DOMContentLoaded„Ç§„Éô„É≥„Éà„ÅßÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>